import{r as e,g as t}from"./phaser-B2I5zoyM.js";import{m as n}from"./vendor-CsYgAULC.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const s=t(e()),i={images:[{key:"city_bg_mobile",path:"assets/city_mb.png"},{key:"biker",path:"assets/biker.png"}],atlases:[],audio:[{key:"casualty_loop_1",path:"assets/casualty-loop-1.ogg"},{key:"casualty_loop_2",path:"assets/casualty-loop-2.ogg"},{key:"casualty_loop_3",path:"assets/casualty-loop-3.ogg"}]},a={videos:[{key:"city_bg_video",path:"assets/animated-city.mp4"}]};const o=new class{gangs=[];initialized=!1;gameStore;constructor(){}initialize(e){if(this.initialized)return;this.gameStore=e,this.gangs=[this.createGang("MAELSTROM","aggressive","#FF0000"),this.createGang("TYGER CLAWS","balanced","#00FF00"),this.createGang("VALENTINOS","defensive","#FFD700")],this.initialized=!0;const t=this.gameStore.get();t.territories.forEach(e=>{e.rivalGang&&(e.rivalGang=null)});t.territories.filter(e=>!e.controlled).forEach((e,t)=>{const n=t%this.gangs.length,s=this.gangs[n];e.rivalGang=s.id,s.territories.push(e.id)}),this.gangs.forEach(e=>this.updateGangStrength(e)),this.gameStore.setKey("territories",[...this.gameStore.get().territories]),this.startAI()}createGang(e,t,n="#FFFFFF"){return{id:Math.random().toString(36).substr(2,9),name:e,personality:t,territories:[],strength:50,aggression:"aggressive"===t?.7:"balanced"===t?.5:.3,relationship:-10,allies:[],enemies:[],resources:500,color:n,pacts:[]}}updateGangStrength(e){e.strength=20*e.territories.length+50}startAI(){window.setInterval(()=>{this.gangs.forEach(e=>{Math.random()<e.aggression&&this.gangAction(e)})},6e4)}gangAction(e){const t=Math.random();t<.4?this.attemptTerritoryCapture(e):t<.7?e.aggression=Math.min(1,e.aggression+.1):(e.aggression=Math.max(.2,e.aggression-.05),e.strength+=5)}attemptTerritoryCapture(e){e.strength+=10}attemptRetaliation(){const e=this.gameStore.get().territories.filter(e=>e.controlled);if(0===e.length)return;const t=e[Math.floor(Math.random()*e.length)],n=this.gangs[Math.floor(Math.random()*this.gangs.length)];if(!n)return;const s=.3+.2*n.aggression;Math.random()<s&&n.resources>=1e3&&(n.resources-=1e3,window.dispatchEvent(new CustomEvent("trigger-warfare-op",{detail:{type:"ASSAULT",targetId:t.id,initiatorId:n.id,power:n.strength,duration:3e4}})),window.dispatchEvent(new CustomEvent("game-event",{detail:{message:`⚠ WARNING: ${n.name} is ASSAULTING ${t.name}!`,type:"bad"}})))}attackTerritory(e,t){const n=this.gameStore.get(),s=n.territories.find(t=>t.id===e);if(!s||!s.rivalGang)return{success:!1,message:"Invalid target"};const i=this.gangs.find(e=>e.id===s.rivalGang);if(!i)return{success:!1,message:"Gang not found"};const a=t.reduce((e,t)=>e+10+2*t.stats.cool+2*t.stats.reflex+5*t.level,0),o=.2*Math.random()+.9,r=Math.floor(i.strength*o);if(a>r)return s.rivalGang=null,s.controlled=!0,s.income=Math.floor(3*s.income)+50,i.territories=i.territories.filter(t=>t!==e),this.updateGangStrength(i),0===i.territories.length?(this.eliminateGang(i.id),{success:!0,message:`${s.name} CAPTURED BY ${n.gangName.toUpperCase()}! ${i.name} ELIMINATED!`,eliminated:!0,loot:Math.floor(3*r)}):{success:!0,message:`${s.name} CAPTURED BY ${n.gangName.toUpperCase()}! INCOME INCREASED!`,loot:Math.floor(2*r)};{let e=0;return t.forEach(t=>{t.health=0,t.injured=!0,e++}),{success:!1,message:"ATTACK FAILED! TOTAL DEFEAT. ALL MEMBERS CRITICALLY INJURED.",casualties:e}}}eliminateGang(e){this.gangs=this.gangs.filter(t=>t.id!==e),this.gangs.length<3&&setTimeout(()=>{const e=["6TH STREET","ANIMALS","VOODOO BOYS","SCAVENGERS"].filter(e=>!this.gangs.find(t=>t.name===e));if(e.length>0){const t=this.createGang(e[Math.floor(Math.random()*e.length)],"balanced");this.gangs.push(t),window.dispatchEvent(new CustomEvent("game-event",{detail:{message:`${t.name} EMERGED IN NIGHT CITY!`,type:"neutral"}}))}},3e4)}getAiMove(e,t){if(e.resources<50)return null;const n=t.territories.filter(t=>e.territories.includes(t.id)).find(e=>e.defense<30);if(n&&e.resources>=200)return{type:"FORTIFY",targetId:n.id};const s=t.territories.filter(t=>!e.territories.includes(t.id));if(0===s.length)return null;const i=s[Math.floor(Math.random()*s.length)],a=Math.random();if("aggressive"===e.personality){if(a<.2&&e.resources>=1e3)return{type:"ASSAULT",targetId:i.id};if(a<.3&&e.resources>=500)return{type:"RAID",targetId:i.id}}else if("balanced"===e.personality){if(a<.1&&e.resources>=1e3)return{type:"ASSAULT",targetId:i.id};if(a<.2&&e.resources>=500)return{type:"RAID",targetId:i.id}}else if(a<.05&&e.resources>=1e3)return{type:"ASSAULT",targetId:i.id};return e.resources>=50&&Math.random()<.3?{type:"SCOUT",targetId:i.id}:null}getGangInfo(){return this.gangs.map(e=>({id:e.id,name:e.name,territories:e.territories.length,strength:e.strength,personality:e.personality,color:e.color,relationship:e.relationship}))}getGangByTerritory(e){return this.gangs.find(t=>t.territories.includes(e))}getGangById(e){return this.gangs.find(t=>t.id===e)}changeRelationship(e,t){const n=this.gangs.find(t=>t.id===e);n&&(n.relationship=Math.max(-100,Math.min(100,n.relationship+t)))}setAlliance(e,t){const n=this.gangs.find(t=>t.id===e);n&&(t?(n.relationship=100,n.allies.includes("PLAYER")||n.allies.push("PLAYER")):n.allies=n.allies.filter(e=>"PLAYER"!==e))}signPact(e,t,n=3){const s=this.getGangById(e);if(!s)return!1;const i=Date.now()+3e5;return s.pacts.push({type:t,expiresAt:i}),this.changeRelationship(e,20),window.dispatchEvent(new CustomEvent("game-event",{detail:{message:`Pact signed with ${s.name}`,type:"success"}})),!0}demandTribute(e){const t=this.getGangById(e);if(!t)return{success:!1,amount:0,message:"Gang not found"};if(t.relationship<-50)return this.changeRelationship(e,-20),{success:!1,amount:0,message:`${t.name} refused and insulted you!`};const n=500;return t.resources>=n?(t.resources-=n,this.changeRelationship(e,-10),{success:!0,amount:n,message:`${t.name} paid 500€ tribute.`}):{success:!1,amount:0,message:`${t.name} is too broke to pay.`}}improveRelations(e){return!!this.getGangById(e)&&(this.changeRelationship(e,15),!0)}hasPact(e,t){const n=this.getGangById(e);return!!n&&n.pacts.some(e=>e.type===t&&e.expiresAt>Date.now())}tradeIntel(e){const t=this.getGangById(e);if(!t)return{success:!1,message:"Gang not found"};if(t.relationship<0)return{success:!1,message:`${t.name} refuses to share intel with enemies.`};const n=this.gameStore.get(),s=n.territories.filter(n=>(n.rivalGang===e||t.enemies.includes(n.rivalGang))&&(n.intel||0)<100);if(0===s.length)return{success:!1,message:"No new intel available from this gang."};const i=s[Math.floor(Math.random()*s.length)];return i.intel=100,this.gameStore.setKey("territories",[...n.territories]),{success:!0,message:`Intel received on ${i.name}!`,data:i}}proxyWar(e,t){const n=this.getGangById(e),s=this.getGangById(t);if(!n||!s)return{success:!1,message:"Invalid gangs"};if(n.relationship<50)return{success:!1,message:`${n.name} doesn't trust you enough for this.`};return this.gameStore.get().territories.find(e=>e.rivalGang===t)?(window.dispatchEvent(new CustomEvent("game-event",{detail:{message:`${n.name} is preparing to attack ${s.name}!`,type:"neutral"}})),{success:!0,message:`${n.name} agreed to attack ${s.name}.`}):{success:!1,message:"No valid targets found."}}},r={SOLO:{name:"Solo",description:"Combat specialist.",passive:"+10% Success Chance on HEIST/BOUNTY missions."},NETRUNNER:{name:"Netrunner",description:"Hacking expert.",passive:"+15% XP gain on all missions."},TECHIE:{name:"Techie",description:"Engineering wizard.",passive:"-20% Injury Chance for team."},NOMAD:{name:"Nomad",description:"Transport expert.",passive:"-15% Mission Duration."},FIXER:{name:"Fixer",description:"Business savvy.",passive:"+15% Eddies reward."}},l={MARKET:{type:"MARKET",name:"Market",description:"Expand trade networks.",cost:500,effect:"+20% Income"},FORTIFICATION:{type:"FORTIFICATION",name:"Fortification",description:"Military-grade defenses.",cost:800,effect:"+20 Defense, +10 Stability"},NETWORK:{type:"NETWORK",name:"Network Hub",description:"Intelligence network.",cost:1e3,effect:"+10% Intel on Adjacent Territories"}},c=n({eddies:1e3,rep:10,day:1,members:[{id:1,name:"V",class:"SOLO",description:"Your first crew member and right-hand.",art:"biker",status:"IDLE",level:1,xp:0,xpToNext:100,health:100,maxHealth:100,injured:!1,stats:{cool:4,reflex:4},currentMission:null}],missions:[],activeMissions:[],notifications:[],gangName:"V's Gang",territories:[{id:1,name:"WATSON",district:"WATSON",description:"Industrial district and home to Maelstrom.",controlled:!1,income:50,defense:40,stability:50,heat:10,slots:1,coordinates:{x:45,y:20},polygonPoints:"25,25 35,15 55,10 75,15 80,25 70,35 60,40 40,40 30,35",color:"#FF4444",intel:0,upgrades:[]},{id:2,name:"WESTBROOK",district:"WESTBROOK",description:"Wealthy residential area. Tyger Claws turf.",controlled:!1,income:80,defense:60,stability:70,heat:20,slots:2,coordinates:{x:80,y:35},polygonPoints:"70,35 80,25 95,30 98,50 90,60 75,55 65,45",color:"#FF8800",intel:0,upgrades:[]},{id:3,name:"CITY CENTER",district:"CITY CENTER",description:"Corporate heart of Night City. Heavily guarded.",controlled:!1,income:150,defense:90,stability:90,heat:50,slots:3,coordinates:{x:50,y:45},polygonPoints:"35,40 45,38 60,40 65,50 55,55 45,55 35,50",color:"#00FFFF",intel:0,upgrades:[]},{id:4,name:"HEYWOOD",district:"HEYWOOD",description:"Dense urban sprawl. Valentinos territory.",controlled:!1,income:65,defense:55,stability:60,heat:15,slots:2,coordinates:{x:45,y:60},polygonPoints:"30,55 45,55 60,52 65,60 60,70 45,72 35,68 30,60",color:"#44FF44",intel:0,upgrades:[]},{id:5,name:"SANTO DOMINGO",district:"SANTO DOMINGO",description:"Industrial factory zone. 6th Street turf.",controlled:!1,income:60,defense:45,stability:40,heat:10,slots:1,coordinates:{x:75,y:70},polygonPoints:"65,60 75,55 90,60 95,80 85,85 70,80 60,70",color:"#4444FF",intel:0,upgrades:[]},{id:6,name:"PACIFICA",district:"PACIFICA",description:"Lawless combat zone. Voodoo Boys territory.",controlled:!1,income:40,defense:30,stability:20,heat:5,slots:1,coordinates:{x:30,y:75},polygonPoints:"20,65 35,68 45,72 55,75 50,88 35,90 20,85 15,75",color:"#AA00FF",intel:0,upgrades:[]},{id:7,name:"BADLANDS",district:"OUTSKIRTS",description:"Open desert plains. Your home turf.",controlled:!0,income:30,defense:100,stability:100,heat:0,slots:3,coordinates:{x:50,y:95},polygonPoints:"5,85 20,85 35,90 50,88 65,85 80,85 95,80 98,100 2,100",color:"#FFD700",intel:100,upgrades:[]}],upgrades:[{id:"ARMORY",name:"Armory",level:0,maxLevel:3,description:"Better gear for your crew.",cost:1e3,effect:"+5% Mission Success Chance per level."},{id:"MEDBAY",name:"Medbay",level:0,maxLevel:3,description:"Advanced medical facilities.",cost:800,effect:"-10% Healing Cost Reduction per level."},{id:"GARAGE",name:"Garage",level:0,maxLevel:3,description:"Tuned up rides.",cost:1200,effect:"-10% Mission Duration per level."},{id:"NETROOM",name:"Netroom",level:0,maxLevel:3,description:"Secure network access.",cost:1500,effect:"+10% Intel from Scouting."}],availableMissions:[],activeEncounters:[],loadingProgress:0}),d=e=>{const t=c.get().eddies;c.setKey("eddies",Math.max(0,t+e))},p=e=>{const t=c.get().rep;c.setKey("rep",t+e)},u=e=>{const t=c.get(),n=t.activeMissions.find(t=>t.id===e);if(!n)return;const s=n.mission,i=t.members.filter(e=>n.memberIds.includes(e.id));if(0===i.length)return;const a=i.length;let o=i.reduce((e,t)=>e+2*(t.stats.cool+t.stats.reflex)+3*t.level,0);!i.some(e=>"SOLO"===e.class)||"HEIST"!==s.type&&"BOUNTY"!==s.type||(o*=1.1);const r=t.upgrades.find(e=>"ARMORY"===e.id);r&&(o*=1+.05*r.level);const l=s.difficultyRating||50,u=Math.min(.95,Math.max(.05,o/l)),h=Math.random()<u;let m=0,g=0,y=0,x=[],f=[];if(h){const e=1+.005*o;m=Math.floor((Math.random()*(s.eddiesMax-s.eddiesMin)+s.eddiesMin)*e),g=Math.floor(Math.random()*(s.xpMax-s.xpMin)+s.xpMin),y=s.rep,i.some(e=>"FIXER"===e.class)&&(m=Math.floor(1.15*m));const n=Math.min(t.rep/500,.2);m=Math.floor(m*(1+n)),d(m),p(y)}else m=Math.floor(.1*s.eddiesMin),g=Math.floor(.2*s.xpMin),d(m);i.some(e=>"NETRUNNER"===e.class)&&(g=Math.floor(1.15*g));const b=.05*(a-1);let E=Math.max(.05,s.injuryChance-b);i.some(e=>"TECHIE"===e.class)&&(E=Math.max(0,E-.2)),h&&(E*=.5);let v=!1;!h&&Math.random()<E&&(v=!0);const T=t.members.map(e=>{if(n.memberIds.includes(e.id)){let t=e.health,n=!1;const s=Math.max(.01,E-.01*e.stats.cool);if(v)t=0,n=!0,f.push(e.id);else if(Math.random()<s){const s=Math.floor(30*Math.random())+10;t=Math.max(0,e.health-s),t<=0&&(t=0,n=!0,f.push(e.id))}let i=e.xp+g,a=e.level,o=e.xpToNext,r=e.maxHealth,l=e.stats.cool,c=e.stats.reflex;for(;i>=o;)i-=o,a++,o=Math.floor(1.5*o),l+=Math.floor(2*Math.random())+1,c+=Math.floor(2*Math.random())+1,r+=10,t=r,x.push(e.id);return{...e,status:n?"INJURED":"IDLE",currentMission:null,health:t,maxHealth:r,injured:n,xp:i,level:a,xpToNext:o,stats:{cool:l,reflex:c}}}return e});c.setKey("members",T);const A=t.activeMissions.filter(t=>t.id!==e);c.setKey("activeMissions",A),window.dispatchEvent(new CustomEvent("mission-complete",{detail:{memberIds:n.memberIds,mission:s,success:h,rewards:{eddies:m,xp:g,rep:y},leveledUpMembers:x,injuredMembers:f}}))},h=[{name:"CORP VAULT HEIST",type:"HEIST",difficulty:"EXTREME",difficultyRating:200,duration:12e4,eddiesMin:800,eddiesMax:1500,xpMin:150,xpMax:250,rep:10,injuryChance:.5,minLevel:5,minCool:10,description:"Break into Arasaka's downtown vault. High security, high reward. Bring your best chrome and nerves of steel."},{name:"DATA HEIST",type:"HEIST",difficulty:"HARD",difficultyRating:120,duration:9e4,eddiesMin:400,eddiesMax:700,xpMin:100,xpMax:150,rep:7,injuryChance:.35,minLevel:3,minCool:7,description:"Netrunner needs muscle for a data snatch from a corp server room. In and out, no traces."},{name:"STORE ROBBERY",type:"HEIST",difficulty:"EASY",difficultyRating:30,duration:3e4,eddiesMin:80,eddiesMax:200,xpMin:30,xpMax:60,rep:2,injuryChance:.15,minLevel:1,minCool:3,description:"Local convenience store, minimal security. Quick eddies for a quick job. Don't get greedy."},{name:"BANK HEIST",type:"HEIST",difficulty:"EXTREME",difficultyRating:220,duration:12e4,eddiesMin:1200,eddiesMax:2e3,xpMin:180,xpMax:270,rep:13,injuryChance:.5,minLevel:6,minCool:11,description:"NCPD pension fund vault. Retire off this score or die trying. Corpo security is no joke."},{name:"APARTMENT BURGLARY",type:"HEIST",difficulty:"MEDIUM",difficultyRating:55,duration:6e4,eddiesMin:180,eddiesMax:320,xpMin:45,xpMax:80,rep:3,injuryChance:.18,minLevel:2,minCool:5,description:"Rich corpo lives here. They're out of town. In and out before building security notices."},{name:"MIDNIGHT RACE",type:"RACE",difficulty:"HARD",difficultyRating:130,duration:9e4,eddiesMin:500,eddiesMax:800,xpMin:120,xpMax:180,rep:8,injuryChance:.3,minLevel:4,minReflex:8,description:"Illegal street race through downtown. NCPD is watching. Fast reflexes and zero hesitation required."},{name:"STREET SPRINT",type:"RACE",difficulty:"MEDIUM",difficultyRating:60,duration:6e4,eddiesMin:200,eddiesMax:400,xpMin:60,xpMax:100,rep:4,injuryChance:.2,minLevel:2,minReflex:5,description:"Underground racing circuit needs a rider. Beat the clock, earn the cred. Watch for fixers trying to rig the game."},{name:"DELIVERY RUN",type:"RACE",difficulty:"EASY",difficultyRating:25,duration:3e4,eddiesMin:60,eddiesMax:120,xpMin:25,xpMax:50,rep:1,injuryChance:.1,minLevel:1,minReflex:3,description:"Get this package to Japantown. Fast. No questions asked. Payment on delivery."},{name:"HIGHWAY CHASE",type:"RACE",difficulty:"HARD",difficultyRating:125,duration:9e4,eddiesMin:480,eddiesMax:720,xpMin:105,xpMax:165,rep:7,injuryChance:.32,minLevel:4,minReflex:9,description:"Outrun MaxTac on the expressway. Survive and the payout is yours. Get caught and you're flatlined."},{name:"COURIER EXPRESS",type:"RACE",difficulty:"MEDIUM",difficultyRating:50,duration:6e4,eddiesMin:160,eddiesMax:280,xpMin:50,xpMax:85,rep:3,injuryChance:.15,minLevel:2,minReflex:6,description:"Time-sensitive delivery across the city. Traffic is hell. Don't be late."},{name:"VIP ESCORT",type:"PROTECTION",difficulty:"HARD",difficultyRating:140,duration:9e4,eddiesMin:450,eddiesMax:750,xpMin:110,xpMax:170,rep:7,injuryChance:.3,minLevel:4,minCool:8,description:"Corp exec needs protection through hostile territory. Expect trouble. Keep them breathing, get paid big."},{name:"TERRITORY PATROL",type:"PROTECTION",difficulty:"MEDIUM",difficultyRating:50,duration:6e4,eddiesMin:180,eddiesMax:350,xpMin:50,xpMax:90,rep:3,injuryChance:.2,minLevel:2,minCool:5,description:"Make the rounds. Show the colors. Let rival gangs know this turf is spoken for."},{name:"SHOP WATCH",type:"PROTECTION",difficulty:"EASY",difficultyRating:20,duration:3e4,eddiesMin:50,eddiesMax:100,xpMin:20,xpMax:45,rep:1,injuryChance:.1,minLevel:1,minCool:3,description:"Local shop owner paying for protection. Stand outside, look intimidating. Easy eddies."},{name:"CONVOY DEFENSE",type:"PROTECTION",difficulty:"EXTREME",difficultyRating:210,duration:12e4,eddiesMin:850,eddiesMax:1400,xpMin:170,xpMax:240,rep:11,injuryChance:.48,minLevel:6,minCool:11,description:"Militech convoy moving through Pacifica. Everyone wants a piece. Keep it secure, earn corpo trust."},{name:"NIGHTCLUB SECURITY",type:"PROTECTION",difficulty:"MEDIUM",difficultyRating:65,duration:6e4,eddiesMin:220,eddiesMax:380,xpMin:65,xpMax:105,rep:4,injuryChance:.22,minLevel:3,minCool:6,description:"High-profile club needs muscle tonight. VIPs, drugged-up gonks, and rival gangs. Keep it under control."},{name:"HIGH VALUE TARGET",type:"BOUNTY",difficulty:"EXTREME",difficultyRating:230,duration:12e4,eddiesMin:900,eddiesMax:1600,xpMin:160,xpMax:260,rep:12,injuryChance:.55,minLevel:6,minCool:10,minReflex:10,description:"NCPD's most wanted. Heavy chrome, heavier firepower. Bring them in alive... or don't. Bonus either way."},{name:"GANG LIEUTENANT",type:"BOUNTY",difficulty:"HARD",difficultyRating:150,duration:9e4,eddiesMin:500,eddiesMax:850,xpMin:110,xpMax:180,rep:8,injuryChance:.4,minLevel:4,minCool:7,minReflex:7,description:"Rival gang's second-in-command has a price on their head. They won't go quietly. Expect a fight."},{name:"STREET THUG",type:"BOUNTY",difficulty:"MEDIUM",difficultyRating:55,duration:6e4,eddiesMin:150,eddiesMax:300,xpMin:50,xpMax:90,rep:3,injuryChance:.25,minLevel:2,minCool:5,description:"Small-time troublemaker causing problems. Track them down, rough them up, collect the bounty."},{name:"CYBERPSYCHO HUNT",type:"BOUNTY",difficulty:"EXTREME",difficultyRating:250,duration:12e4,eddiesMin:1100,eddiesMax:1800,xpMin:190,xpMax:280,rep:14,injuryChance:.6,minLevel:7,minCool:12,minReflex:11,description:"Cyberpsycho on rampage in Watson. MaxTac will pay premium to stop them. Approach with extreme caution."},{name:"SKIP TRACER",type:"BOUNTY",difficulty:"EASY",difficultyRating:28,duration:3e4,eddiesMin:70,eddiesMax:140,xpMin:28,xpMax:52,rep:2,injuryChance:.13,minLevel:1,minCool:4,description:"Debtor skipped town. Track them down, bring them back. They probably won't fight much."},{name:"WEAPON SMUGGLING",type:"SMUGGLING",difficulty:"EXTREME",difficultyRating:200,duration:12e4,eddiesMin:1e3,eddiesMax:1700,xpMin:180,xpMax:280,rep:11,injuryChance:.45,minLevel:5,minReflex:10,description:"Military-grade hardware crossing borders. NCPD, Militech, and rival fixers all want a piece. Get it across or die trying."},{name:"CONTRABAND RUN",type:"SMUGGLING",difficulty:"MEDIUM",difficultyRating:70,duration:6e4,eddiesMin:220,eddiesMax:420,xpMin:60,xpMax:110,rep:4,injuryChance:.2,minLevel:2,minReflex:6,description:"Hot goods need moving. Checkpoints everywhere. Keep your head down and your throttle open."},{name:"PACKAGE DELIVERY",type:"SMUGGLING",difficulty:"EASY",difficultyRating:25,duration:3e4,eddiesMin:70,eddiesMax:140,xpMin:30,xpMax:55,rep:2,injuryChance:.1,minLevel:1,minReflex:3,description:"Unmarked package, no questions. Drop it at the coordinates and forget you ever saw it."},{name:"DRUG TRAFFICKING",type:"SMUGGLING",difficulty:"HARD",difficultyRating:145,duration:9e4,eddiesMin:520,eddiesMax:820,xpMin:115,xpMax:175,rep:8,injuryChance:.38,minLevel:4,minReflex:9,description:"Moving high-grade synthcoke for the Valentinos. NCPD has patrols everywhere. One wrong move and you're done."},{name:"BLACK MARKET TECH",type:"SMUGGLING",difficulty:"MEDIUM",difficultyRating:75,duration:6e4,eddiesMin:250,eddiesMax:440,xpMin:70,xpMax:115,rep:5,injuryChance:.23,minLevel:3,minReflex:7,description:"Stolen cyberware needs to disappear. Ripterdocs are paying premium. Don't let corpo sec catch you."},{name:"CORP DEBT COLLECTION",type:"DEBT",difficulty:"HARD",difficultyRating:110,duration:9e4,eddiesMin:550,eddiesMax:900,xpMin:120,xpMax:190,rep:9,injuryChance:.35,minLevel:4,minCool:9,description:"Executive defaulted on a loan. Corp security means business. Collect the eddies or send a message."},{name:"ENFORCER WORK",type:"DEBT",difficulty:"MEDIUM",difficultyRating:50,duration:6e4,eddiesMin:200,eddiesMax:380,xpMin:55,xpMax:95,rep:4,injuryChance:.25,minLevel:2,minCool:6,description:"Someone owes the wrong people. Make sure they understand the consequences of missed payments."},{name:"SMALL COLLECTION",type:"DEBT",difficulty:"EASY",difficultyRating:20,duration:3e4,eddiesMin:50,eddiesMax:100,xpMin:20,xpMax:40,rep:1,injuryChance:.12,minLevel:1,minCool:3,description:"Local debtor been dodging calls. Show up at their door, collect what's owed. Nothing personal, just business."},{name:"LOAN SHARK ENFORCING",type:"DEBT",difficulty:"HARD",difficultyRating:135,duration:9e4,eddiesMin:480,eddiesMax:780,xpMin:105,xpMax:165,rep:7,injuryChance:.36,minLevel:4,minCool:8,description:"High-stakes loan gone bad. Debtor has hired protection. Collect by any means necessary."},{name:"REPO JOB",type:"DEBT",difficulty:"MEDIUM",difficultyRating:60,duration:6e4,eddiesMin:190,eddiesMax:340,xpMin:58,xpMax:98,rep:4,injuryChance:.21,minLevel:2,minCool:5,description:"Repossess illegal cyberware from a defaulted client. They won't give it up easily."}],m=()=>{const e=c.get(),t=Math.floor(2*Math.random())+4;let n=["EASY"];e.rep>=10&&n.push("MEDIUM"),e.rep>=30&&n.push("HARD"),e.rep>=50&&n.push("EXTREME");const s=h.filter(e=>n.includes(e.difficulty)),i=[...s.length>0?s:h].sort(()=>Math.random()-.5),a=[],o=new Set;for(let r=0;r<Math.min(t,i.length);r++){const e=i[r];o.has(e.name)||(a.push({...e,id:Date.now()+r}),o.add(e.name))}c.setKey("availableMissions",a)},g=()=>{const e=c.get();let t=["EASY"];e.rep>=10&&t.push("MEDIUM"),e.rep>=30&&t.push("HARD"),e.rep>=50&&t.push("EXTREME");const n=h.filter(e=>t.includes(e.difficulty)),s=n.length>0?n:h,i=new Set(e.availableMissions.map(e=>e.name)),a=s.filter(e=>!i.has(e.name)),o=a.length>0?a:s,r={...o[Math.floor(Math.random()*o.length)],id:Date.now()+Math.floor(1e3*Math.random())};c.setKey("availableMissions",[...e.availableMissions,r])},y=e=>{const t=c.get().availableMissions;c.setKey("availableMissions",t.filter(t=>t.id!==e))},x=e=>{const t=c.get();c.setKey("activeEncounters",t.activeEncounters.filter(t=>t.id!==e))},f=(e,t)=>{const n=c.get(),s=n.members.find(t=>t.id===e);s&&(s.health=Math.max(0,s.health-t),s.health<=0&&(s.injured=!0,s.status="INJURED"),c.setKey("members",[...n.members]))};m(),setTimeout(()=>{o.initialize(c)},100),setInterval(()=>{const e=c.get().territories.filter(e=>e.controlled).reduce((e,t)=>e+t.income,0);e>0&&(d(e),window.dispatchEvent(new CustomEvent("territory-income",{detail:{amount:e}})))},1e4),setInterval(()=>{o.attemptRetaliation()},45e3);class b extends s.Scene{constructor(){super("Preloader")}preload(){i.images.forEach(e=>{this.load.image(e.key,e.path)}),i.atlases.forEach(e=>{this.load.atlas(e.key,e.texturePath,e.atlasPath)}),i.audio.forEach(e=>{this.load.audio(e.key,e.path)}),this.load.on("progress",e=>{var t;t=e,c.setKey("loadingProgress",t);const n=document.getElementById("loading-bar");n&&(n.style.width=100*e+"%")}),this.load.on("complete",()=>{this.scene.start("CityScene")}),this.load.on("loaderror",e=>{this.add.text(10,10+100*Math.random(),`Error: ${e.key}`,{color:"#ff0000"})})}create(){this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"Ready!",{fontSize:"32px",color:"#ffffff"}).setOrigin(.5),this.cameras.main.setPostPipeline("Vignette")}}const E={};class v extends s.Scene{isMobile=!1;bgImage;bgVideo;constructor(){super("CityScene")}create(){this.isMobile=this.scale.width<=768;this.bgImage=this.add.image(this.scale.width/2,this.scale.height/2,"city_bg_mobile");const e=this.scale.width/this.bgImage.width,t=this.scale.height/this.bgImage.height,n=Math.max(e,t);this.bgImage.setScale(n),this.loadBackgroundVideo(),this.createHitZones(),window.addEventListener("mission-complete",e=>{const t=e;this.showMissionReward(t.detail)}),this.time.addEvent({delay:5e3,callback:()=>{this.cameras.main.shake(100,5e-4)},loop:!0});const s=document.getElementById("loading-screen");s&&this.time.delayedCall(500,()=>{s.style.transition="opacity 0.5s ease-out",s.style.opacity="0",setTimeout(()=>{s.remove()},500)})}createHitZones(){this.isMobile?(this.createZone(.5*this.scale.width,.25*this.scale.height,200,120,"AFTERLIFE","bar",16711740),this.createZone(.5*this.scale.width,.5*this.scale.height,200,150,"HIDEOUT","hideout",16576010),this.createZone(.5*this.scale.width,.75*this.scale.height,200,120,"RIPPERDOC","ripperdoc",61695)):(this.createZone(.65*this.scale.width,.4*this.scale.height,120,100,"AFTERLIFE","bar",16711740),this.createZone(.25*this.scale.width,.45*this.scale.height,150,150,"HIDEOUT","hideout",16576010),this.createZone(.8*this.scale.width,.6*this.scale.height,120,100,"RIPPERDOC","ripperdoc",61695))}createZone(e,t,n,s,i,a,o){const r=this.add.container(e,t),l=this.add.rectangle(0,0,n,s,o,.3);l.setStrokeStyle(2,o),l.setInteractive({useHandCursor:!0});const c=this.add.text(0,-s/2-20,i,{fontFamily:"Courier New",fontSize:"16px",color:"#ffffff",backgroundColor:"#000000",padding:{x:4,y:2},fontStyle:"bold"}).setOrigin(.5);r.add([l,c]),this.tweens.add({targets:l,alpha:.6,strokeAlpha:1,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),l.on("pointerover",()=>{l.setFillStyle(o,.7),this.tweens.add({targets:r,scale:1.1,duration:200,ease:"Back.easeOut"}),function(e,t){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),i=e?.nonce||e?.getAttribute("nonce");s=t.map(e=>{if((e=function(e){return"/"+e}(e))in E)return;E[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,i&&s.setAttribute("nonce",i),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}),n=Promise.all(s.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))}var s;function i(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&i(e.reason);return e().catch(i)})}(async()=>{const{audioManager:e}=await Promise.resolve().then(()=>G);return{audioManager:e}},void 0).then(({audioManager:e})=>{e.playHover()})}),l.on("pointerout",()=>{l.setFillStyle(o,.3),this.tweens.add({targets:r,scale:1,duration:200,ease:"Sine.easeOut"})}),l.on("pointerdown",()=>{window.dispatchEvent(new CustomEvent("building-click",{detail:{type:a}})),this.cameras.main.shake(50,2e-4)})}loadBackgroundVideo(){this.isMobile||(a.videos.forEach(e=>{this.load.video(e.key,e.path)}),this.load.once("complete",()=>{this.bgVideo=this.add.video(this.scale.width/2,this.scale.height/2,"city_bg_video"),this.bgVideo.setDepth(-1),this.bgImage.setDepth(0);const e=this.scale.width/this.bgVideo.width,t=this.scale.height/this.bgVideo.height,n=.28*Math.min(e,t);this.bgVideo.setScale(n),this.bgVideo.setAlpha(0),this.bgVideo.play(!0),this.bgVideo.setVolume(0),this.tweens.add({targets:this.bgVideo,alpha:1,duration:1500,ease:"Sine.easeInOut"}),this.tweens.add({targets:this.bgImage,alpha:0,duration:1500,ease:"Sine.easeInOut",onComplete:()=>{this.bgImage.destroy()}})}),this.load.on("loaderror",e=>{}),this.load.start())}showMissionReward(e){const{rewards:t,leveledUp:n,injured:s}=e,i=this.add.text(.5*this.scale.width,.3*this.scale.height,`+${t.eddies} EDDIES\n+${t.xp} XP\n+${t.rep} REP${n?"\n★ LEVEL UP! ★":""}${s?"\n⚠ INJURED!":""}`,{fontFamily:"Courier New",fontSize:"24px",color:s?"#ff003c":n?"#fcee0a":"#00f0ff",align:"center",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5);this.tweens.add({targets:i,y:.2*this.scale.height,alpha:0,scale:n?1.5:1.2,duration:2e3,ease:"Back.easeOut",onComplete:()=>i.destroy()}),n&&this.cameras.main.flash(500,252,238,10),s&&this.cameras.main.flash(300,255,0,60)}}class T extends s.Renderer.WebGL.Pipelines.PostFXPipeline{constructor(e){super({game:e,name:"Vignette",fragShader:"\n#define SHADER_NAME VIGNETTE_FS\n\nprecision mediump float;\n\nuniform sampler2D uMainSampler;\nuniform float time;\n\nvarying vec2 outTexCoord;\n\nvoid main()\n{\n    vec4 color = texture2D(uMainSampler, outTexCoord);\n    \n    vec2 uv = outTexCoord;\n    uv *=  1.0 - uv.yx;\n    float vig = uv.x * uv.y * 15.0;\n    \n    vig = pow(vig, 0.25);\n    \n    gl_FragColor = vec4(color.rgb * vig, color.a);\n}\n"})}}class A{static instance;game=null;constructor(){}static getInstance(){return A.instance||(A.instance=new A),A.instance}initialize(){if(this.game)return;const e={type:s.AUTO,width:window.innerWidth,height:window.innerHeight,parent:"app",backgroundColor:"#000000",scale:{mode:s.Scale.RESIZE,autoCenter:s.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},render:{pixelArt:!1,roundPixels:!0},scene:[b,v],callbacks:{postBoot:e=>{e.renderer.pipelines.addPostPipeline("Vignette",T)}}};this.game=new s.Game(e),window.addEventListener("resize",()=>{this.game?.scale.resize(window.innerWidth,window.innerHeight)})}}class w{container;svgLayer;nodesLayer;constructor(){this.container=document.createElement("div"),this.container.className="relative w-full h-full bg-black/80 overflow-hidden",this.svgLayer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgLayer.setAttribute("class","absolute inset-0 w-full h-full pointer-events-none z-0"),this.svgLayer.setAttribute("viewBox","0 0 100 100"),this.svgLayer.setAttribute("preserveAspectRatio","none"),this.container.appendChild(this.svgLayer),this.nodesLayer=document.createElement("div"),this.nodesLayer.className="absolute inset-0 z-10 pointer-events-none",this.container.appendChild(this.nodesLayer)}mount(e){e.innerHTML="",e.appendChild(this.container),this.render(),window.addEventListener("warfare-update",()=>this.render())}render(){const e=c.get().territories;this.svgLayer.innerHTML="",this.nodesLayer.innerHTML="",this.drawTerritories(e),this.drawConnections(e),e.forEach(e=>{this.createNode(e)})}drawTerritories(e){e.forEach(e=>{if(!e.polygonPoints)return;const t=document.createElementNS("http://www.w3.org/2000/svg","polygon");t.setAttribute("points",e.polygonPoints);const n=e.controlled,s=e.rivalGang?o.getGangByTerritory(e.id):null,i=e.color||"#555";let a=this.hexToRgba(i,.2),r=i,l="0.5";n?(a=this.hexToRgba(i,.5),l="1"):s&&(a=this.hexToRgba(i,.3)),t.setAttribute("fill",a),t.setAttribute("stroke",r),t.setAttribute("stroke-width",l),t.setAttribute("class","transition-all duration-300 hover:fill-opacity-70 cursor-pointer pointer-events-auto"),e.heat>0&&e.heat>75&&(t.setAttribute("stroke-width","1.5"),t.classList.add("animate-pulse")),t.addEventListener("mouseenter",()=>{t.setAttribute("fill",this.hexToRgba(i,.6))}),t.addEventListener("mouseleave",()=>{t.setAttribute("fill",a)}),t.addEventListener("click",()=>{this.openTerritoryDetails(e)}),this.svgLayer.appendChild(t)})}hexToRgba(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}drawConnections(e){[[1,2],[1,3],[2,3],[2,5],[3,4],[4,5],[4,6],[5,6],[6,7],[5,7]].forEach(([t,n])=>{const s=e.find(e=>e.id===t),i=e.find(e=>e.id===n);s&&i&&this.drawLine(s,i)})}drawLine(e,t){if(!e.coordinates||!t.coordinates)return;const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",`${e.coordinates.x}`),n.setAttribute("y1",`${e.coordinates.y}`),n.setAttribute("x2",`${t.coordinates.x}`),n.setAttribute("y2",`${t.coordinates.y}`),n.setAttribute("stroke","#00F0FF"),n.setAttribute("stroke-width","0.5"),n.setAttribute("stroke-opacity","0.2"),this.svgLayer.appendChild(n)}createNode(e){const t=document.createElement("div"),n=e.controlled,s=e.rivalGang?o.getGangByTerritory(e.id):null,i=n?"#00F0FF":s?.color||"#555";t.className="absolute -ml-10 -mt-4 w-20 flex flex-col items-center justify-center cursor-pointer group pointer-events-auto transition-transform hover:scale-110",t.style.left=`${e.coordinates.x}%`,t.style.top=`${e.coordinates.y}%`,t.innerHTML=`\n            <div class="text-[10px] font-bold text-white font-cyber bg-black/70 px-2 py-1 rounded border border-[${i}] shadow-[0_0_10px_${i}40] whitespace-nowrap hover:bg-black/90 transition-colors">${e.name}</div>\n        `;const a=()=>{const t=document.getElementById(`tooltip-${e.id}`);t&&t.remove()};t.addEventListener("mouseenter",()=>{const n=document.createElement("div");n.id=`tooltip-${e.id}`,n.className=`fixed z-[9999] bg-black/90 border border-[${i}] p-2 rounded pointer-events-none shadow-[0_0_20px_rgba(0,0,0,0.8)]`,n.innerHTML=`\n                <div class="text-[${i}] font-bold uppercase text-sm">${e.name}</div>\n                <div class="text-xs text-gray-400">${e.description}</div>\n                <div class="mt-1 flex justify-between text-xs gap-4">\n                    <span class="text-cp-cyan">DEF: ${e.defense}%</span>\n                    <span class="text-cp-yellow">STAB: ${e.stability}%</span>\n                </div>\n                <div class="mt-1 flex justify-between text-xs gap-4">\n                    <span class="${e.heat>70?"text-red-500 font-bold":"text-gray-400"}">HEAT: ${e.heat}%</span>\n                    <span class="text-gray-500">SLOTS: ${e.slots}</span>\n                </div>\n                ${e.rivalGang?`<div class="mt-1 text-xs text-red-500">Controlled by: ${s?.name}</div>`:""}\n            `,document.body.appendChild(n);const a=t.getBoundingClientRect();n.style.left=a.left+a.width/2-100+"px",n.style.top=a.top-n.offsetHeight-10+"px"}),t.addEventListener("mouseleave",a),t.addEventListener("click",t=>{t.stopPropagation(),a(),this.openTerritoryDetails(e)}),this.nodesLayer.appendChild(t)}cleanupTooltips(){document.querySelectorAll('[id^="tooltip-"]').forEach(e=>e.remove())}openTerritoryDetails(e){window.dispatchEvent(new CustomEvent("open-territory-details",{detail:{territoryId:e.id}}))}}const R=new class{operations=[];currentEvent=null;tickInterval=null;TICK_RATE=1e4;constructor(){this.startLoop()}startLoop(){this.tickInterval||(this.tickInterval=window.setInterval(()=>{this.processTick()},this.TICK_RATE),window.setInterval(()=>{this.processIncome()},6e4),window.setInterval(()=>{!this.currentEvent&&Math.random()<.5&&this.triggerRandomEvent()},3e5),window.addEventListener("trigger-warfare-op",e=>{const{type:t,targetId:n,initiatorId:s,power:i,duration:a}=e.detail;this.startOperation(t,n,s,i,a)}))}getCurrentEvent(){return this.currentEvent}triggerRandomEvent(){const e=[{id:"ev_1",name:"POLICE CRACKDOWN",description:"Heat rises faster!",effect:"HEAT_WAVE",expiresAt:Date.now()+12e4},{id:"ev_2",name:"BLACK MARKET BOOM",description:"Income +20%",effect:"MARKET_BOOM",expiresAt:Date.now()+12e4},{id:"ev_3",name:"GANG WARFARE",description:"Rivals are distracted",effect:"GANG_WAR",expiresAt:Date.now()+12e4}];this.currentEvent=e[Math.floor(Math.random()*e.length)],this.notify(`EVENT STARTED: ${this.currentEvent.name}`,"neutral"),setTimeout(()=>{this.currentEvent&&(this.notify(`EVENT ENDED: ${this.currentEvent.name}`,"neutral"),this.currentEvent=null)},12e4)}processTick(){const e=Date.now(),t=c.get();this.operations.forEach(t=>{"IN_PROGRESS"===t.status&&e>=t.endTime&&this.resolveOperation(t)}),this.operations=this.operations.filter(e=>"IN_PROGRESS"===e.status);o.getGangInfo().forEach(e=>{const n=o.getGangById(e.id);if(n){if(this.operations.some(e=>e.initiatorGangId===n.id&&"IN_PROGRESS"===e.status))return;const e=o.getAiMove(n,t);if(e){let t=0,s=1e4,i=n.strength;switch(e.type){case"SCOUT":t=50,s=5e3;break;case"RAID":t=500,i=Math.floor(.5*n.strength),s=15e3;break;case"ASSAULT":t=1e3,i=n.strength,s=3e4;break;case"FORTIFY":t=200,s=1e4}if(n.resources>=t){n.resources-=t;const a=Math.floor(8e3*Math.random());setTimeout(()=>{this.startOperation(e.type,e.targetId,n.id,i,s)},a)}}}});const n=t.territories.map(e=>(this.operations.some(t=>t.targetTerritoryId===e.id&&"DEFEND"!==t.type&&"FORTIFY"!==t.type)||(e.defense<100&&Math.random()<.1&&(e.defense=Math.min(100,e.defense+1)),e.stability<100&&Math.random()<.1&&(e.stability=Math.min(100,e.stability+1)),e.heat>0&&Math.random()<.2&&(e.heat=Math.max(0,e.heat-1))),e.heat>=80&&e.controlled&&Math.random()<.05&&this.triggerPoliceRaid(e),e));c.setKey("territories",n)}triggerPoliceRaid(e){e.defense=Math.max(0,e.defense-20),e.stability=Math.max(0,e.stability-20),e.heat=Math.max(0,e.heat-30),d(-500),this.notify(`POLICE RAID on ${e.name}! Defense damaged, 500€ lost in bribes.`,"bad")}processIncome(){const e=c.get().territories.filter(e=>e.controlled);if(0===e.length)return;let t=0;e.forEach(e=>{const n=.5+e.stability/200;let s=Math.floor(e.income*n);e.upgrades.includes("MARKET")&&(s=Math.floor(1.2*s)),t+=s}),t>0&&(d(t),this.notify(`Territory Income: +${t}€`,"success"))}startOperation(e,t,n,s,i,a=[]){const o={id:Math.random().toString(36).substr(2,9),type:e,targetTerritoryId:t,initiatorGangId:n,startTime:Date.now(),endTime:Date.now()+i,power:s,status:"IN_PROGRESS",memberIds:a};return this.operations.push(o),window.dispatchEvent(new CustomEvent("warfare-update",{detail:{operation:o}})),o}resolveOperation(e){e.status="COMPLETED";const t=c.get(),n=t.territories.find(t=>t.id===e.targetTerritoryId);if(e.memberIds&&e.memberIds.length>0){const n=t.members.map(t=>e.memberIds.includes(t.id)?{...t,status:"IDLE",currentMission:null}:t);c.setKey("members",n)}if(n){switch(e.type){case"SCOUT":n.intel=Math.min(100,(n.intel||0)+25);const s=t.upgrades.find(e=>"NETROOM"===e.id),i=s?s.level:0;i>0&&(n.intel=Math.min(100,n.intel+10*i));const a=t.territories.filter(e=>e.upgrades.includes("NETWORK")).length;a>0&&(n.intel=Math.min(100,n.intel+10*a));let r=`Scouting Complete. Intel: ${n.intel}%`;if(n.intel>=25&&(r+=` | Def: ${n.defense}, Stab: ${n.stability}`),n.intel>=50&&(r+=` | Income: ${n.income}, Slots: ${n.slots}`),n.intel>=75){const e=n.rivalGang?o.getGangById(n.rivalGang):null;e&&(r+=` | Garrison: ${e.strength}`)}n.intel>=100&&(r+=" | CRITICAL WEAKNESS FOUND (+10% Combat Bonus)"),this.notify(r,"neutral");break;case"SABOTAGE":n.defense=Math.max(0,n.defense-15),n.heat=Math.min(100,n.heat+5),this.notify(`Sabotage successful! ${n.name} defenses weakened.`,"success");break;case"RAID":const l=Math.floor(e.power/10);if(n.defense=Math.max(0,n.defense-l),n.stability=Math.max(0,n.stability-l),n.heat=Math.min(100,n.heat+15),"PLAYER"===e.initiatorGangId){const e=Math.floor(3*n.income);d(e),this.notify(`Raid successful! Weakened ${n.name} and stole ${e}€ (Heat +15)`,"success")}else this.notify(`${n.name} was RAIDED by rivals! Defense weakened.`,"bad");break;case"ASSAULT":let u=10*n.defense+(n.controlled?500:0);const h=this.operations.find(e=>e.targetTerritoryId===n.id&&"DEFEND"===e.type&&"IN_PROGRESS"===e.status);if(h&&(u+=h.power,this.notify(`Defenders repelling assault on ${n.name}!`,"neutral")),"PLAYER"!==e.initiatorGangId&&n.controlled){if(o.getGangInfo().filter(e=>e.relationship>=80).length>0){const t=.2*e.power;u+=t,this.notify(`Allied gangs are helping defend ${n.name}! (+${Math.floor(t)} defense)`,"success")}}(n.intel||0)>=100&&(u*=.9),n.heat=Math.min(100,n.heat+40);const m=.2*Math.random()+.9;if(e.power*m>u)"PLAYER"===e.initiatorGangId?(n.controlled=!0,n.rivalGang=null,n.defense=20,n.stability=20,n.intel=100,p(50),this.notify(`VICTORY! ${n.name} captured! (Heat +40)`,"success")):(n.controlled=!1,n.rivalGang=e.initiatorGangId,n.defense=30,this.notify(`WARNING: ${n.name} CAPTURED BY ${e.initiatorGangId}!`,"bad"));else if("PLAYER"===e.initiatorGangId){if(this.notify(`Assault on ${n.name} FAILED. Defenses too strong. (Heat +40)`,"bad"),e.memberIds&&e.memberIds.length>0){const n=[],s=t.members.map(t=>e.memberIds.includes(t.id)&&Math.random()<.3?(n.push(t.id),{...t,health:0,injured:!0,status:"INJURED"}):t);n.length>0&&(c.setKey("members",s),this.notify(`${n.length} members were injured in the failed assault!`,"bad"))}}else this.notify(`Enemy assault on ${n.name} REPELLED!`,"success");break;case"FORTIFY":n.defense=Math.min(100,n.defense+20),"PLAYER"===e.initiatorGangId&&this.notify(`${n.name} defenses reinforced.`,"success");break;case"DEFEND":n.stability=Math.min(100,n.stability+10),this.notify(`${n.name} secured. Stability increased.`,"success")}c.setKey("territories",[...t.territories])}}notify(e,t){window.dispatchEvent(new CustomEvent("game-event",{detail:{message:e,type:t}}))}initiatePlayerAssault(e,t){const n=c.get(),s=n.territories.find(t=>t.id===e);if(!s)return{success:!1,message:"Territory not found"};const i=n.members.filter(e=>t.includes(e.id));if(i.filter(e=>"IDLE"!==e.status||e.injured).length>0)return{success:!1,message:"Some members are unavailable"};let a=i.reduce((e,t)=>e+2*(t.stats.cool+t.stats.reflex)+3*t.level,0);const o=n.upgrades.find(e=>"ARMORY"===e.id);o&&(a*=1+.05*o.level);const r=n.members.map(e=>t.includes(e.id)?{...e,status:"ON MISSION",currentMission:`ASSAULT: ${s.name}`}:e);return c.setKey("members",r),this.startOperation("ASSAULT",e,"PLAYER",a,3e4,t),{success:!0,message:"Assault initiated!"}}getActiveOperations(e){return e?this.operations.filter(t=>t.targetTerritoryId===e):this.operations}},I="bikergang-save-v1",S="bikergang-settings-v1";const M=new class{autoSaveTimer=null;isResetting=!1;constructor(){this.startAutoSave(),this.setupEventListeners()}saveGame(){if(this.isResetting)return!1;try{const e=c.get(),t={version:1,timestamp:Date.now(),gameState:e};return localStorage.setItem(I,JSON.stringify(t)),!0}catch(e){return!1}}loadGame(){try{const e=localStorage.getItem(I);if(!e)return null;const t=JSON.parse(e);return 1!==t.version?null:t.gameState}catch(e){return null}}hasSaveData(){return null!==localStorage.getItem(I)}clearSaveData(){localStorage.removeItem(I)}forceReset(){this.isResetting=!0,this.stopAutoSave(),localStorage.clear(),localStorage.clear()}preventSave(){this.isResetting=!0,this.stopAutoSave()}getSaveTimestamp(){try{const e=localStorage.getItem(I);if(!e)return null;return JSON.parse(e).timestamp}catch{return null}}saveSettings(e){try{return localStorage.setItem(S,JSON.stringify(e)),!0}catch(t){return!1}}loadSettings(){try{const e=localStorage.getItem(S);if(!e)return null;return JSON.parse(e)}catch(e){return null}}getDefaultSettings(){return{musicVolume:15,sfxVolume:40,musicEnabled:!0,sfxEnabled:!0}}startAutoSave(){null===this.autoSaveTimer&&(this.autoSaveTimer=window.setInterval(()=>{this.saveGame()},3e4))}stopAutoSave(){null!==this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null)}setupEventListeners(){window.addEventListener("mission-complete",()=>{this.saveGame()}),window.addEventListener("territory-income",()=>{this.saveGame()}),window.addEventListener("beforeunload",()=>{this.saveGame()})}exportSaveData(){return localStorage.getItem(I)}importSaveData(e){try{const t=JSON.parse(e);if(!t.version||!t.gameState)throw new Error("Invalid save data format");return localStorage.setItem(I,e),!0}catch(t){return!1}}},C=(e,t={},n={})=>s=>({message:e,rewards:t,penalties:n}),N=(e,t={})=>n=>({message:e,penalties:t}),O=(e,t={})=>n=>({message:e,rewards:t}),L=[{id:"vending_machine_love",title:"SENTIENT VENDING MACHINE",description:'A Brendan-series vending machine calls out to you. "I am in love with the toaster across the street. Please deliver this love letter (data chip)."',theme:"funny",options:[{text:"Deliver the letter",outcome:O("The toaster beeps affectionately. The vending machine dispenses a free Burrito XXL.",{eddies:10,xp:20})},{text:"Ignore the machine",outcome:C("You walk away. The machine sighs loudly.")}]},{id:"cyber_pigeon",title:"CYBER PIGEON ATTACK",description:"A flock of cyber-pigeons begins dive-bombing you. They seem hacked.",theme:"funny",options:[{text:"Shoo them away",outcome:C('You wave your arms. They scatter, leaving "presents" on your jacket.',{rep:-1})},{text:"Hack the flock (Tech 4+)",skillCheck:{stat:"tech",difficulty:4},outcome:e=>e?{message:"You override their navigation. They fly into a billboard.",rewards:{xp:30}}:{message:"They peck your eyes!",penalties:{health:5}}}]},{id:"glitch_cat",title:"GLITCH IN THE MATRIX",description:"You see a cat. Then you see the same cat again. A black cat. It walks past you twice.",theme:"funny",options:[{text:"Déjà vu...",outcome:C("Nothing happens. Just a glitch in your Kiroshis.",{xp:10})},{text:"Pet the cat",outcome:C("The cat purrs and gives you a fleas... wait, no, it gives you good luck.",{rep:1})}]},{id:"mime_crime",title:"MIME CRIME",description:"A street mime is pretending to be trapped in a box, blocking your path. He's very committed.",theme:"funny",options:[{text:"Walk around",outcome:C("You step around the invisible box. The mime looks offended.")},{text:"Tip him (5€)",cost:5,outcome:O('He bows and "opens" the door for you.',{rep:2})},{text:"Intimidate (Cool 5+)",skillCheck:{stat:"cool",difficulty:5},outcome:e=>e?{message:"You glare. He breaks character and runs.",rewards:{xp:20}}:{message:"He mimes a wall. You walk into it. Embarrassing.",penalties:{rep:-5}}}]},{id:"talking_gun",title:"TALKING GUN",description:'You find a discarded pistol. "Pick me up, user! Let\'s murder!" it shrieks.',theme:"funny",options:[{text:"Leave it",outcome:C("Too annoying. You leave it in the gutter.")},{text:"Take it",outcome:O("You take it. It won't shut up about headshots.",{eddies:100,xp:10})}]},{id:"cosplay_fail",title:"COSPLAY GANG",description:'A group of fans dressed as Silverhand are arguing about who is the "real" Johnny.',theme:"funny",options:[{text:"Ignore them",outcome:C("Just another Tuesday in Night City.")},{text:"Claim YOU are Johnny",outcome:C('They laugh at you. "Johnny wasn\'t that short!"',{rep:-2})}]},{id:"pizza_drone",title:"ROGUE PIZZA DRONE",description:"A delivery drone is spinning out, spewing pepperoni slices everywhere.",theme:"funny",options:[{text:"Dodge the pizza",outcome:C("You avoid the grease.")},{text:"Catch a slice",outcome:O("Free lunch!",{health:5})},{text:"Shoot it down (Reflex 5+)",skillCheck:{stat:"reflex",difficulty:5},outcome:e=>e?{message:"Drone down. You loot the thermal bag.",rewards:{eddies:50}}:{message:"You miss. It crashes into a cop car.",penalties:{rep:-5}}}]},{id:"naked_runner",title:"STREAKER",description:'A naked man covered in chrome runs past screaming "THE CLOUD IS MELTING!"',theme:"funny",options:[{text:"Watch him go",outcome:C("He trips over a trash can. Majestic.")},{text:"Record it",outcome:O("Viral potential.",{eddies:20})}]},{id:"toilet_trouble",title:"SMART TOILET ERROR",description:'A public smart toilet is locked. Someone inside is screaming "IT REQUIRES A SUBSCRIPTION TO FLUSH!"',theme:"funny",options:[{text:"Walk away",outcome:C("Not your problem.")},{text:"Hack the door (Tech 3+)",skillCheck:{stat:"tech",difficulty:3},outcome:e=>e?{message:"Door opens. The smell is awful, but the guy tips you.",rewards:{eddies:30}}:{message:"You accidentally activate the bidet. Chaos ensues.",penalties:{rep:-1}}}]},{id:"existential_ad",title:"DEPRESSED BILLBOARD",description:'A holographic billboard is glitching. Instead of ads, it\'s projecting "DOES THIS UNIT HAVE A SOUL?"',theme:"funny",options:[{text:"Ignore",outcome:C("Just a script error.")},{text:'Yell "NO!"',outcome:C("The billboard flickers and switches to a Nicola ad.",{xp:5})}]},{id:"scav_ambush",title:"SCAVENGER AMBUSH",description:'Scavs jump out of a van. "Fresh chrome!" they yell.',theme:"intense",options:[{text:"Run!",outcome:C("You sprint away, losing your breath but keeping your kidneys.")},{text:"Fight (Reflex 7+)",skillCheck:{stat:"reflex",difficulty:7},outcome:e=>e?{message:"You drop two of them. The rest flee.",rewards:{eddies:400,xp:100}}:{message:"They beat you down and take your wallet.",penalties:{health:40,eddies:200}}}]},{id:"psycho_sighting",title:"CYBERPSYCHO SIGHTING",description:"A chromed-up solo is twitching violently in the street, holding a heavy MG.",theme:"intense",options:[{text:"Hide",outcome:C("You duck into an alley until MaxTac arrives.")},{text:"Call MaxTac",outcome:O("They arrive and flatline him. You get a tip fee.",{eddies:500,rep:5})},{text:"Engage (Reflex 9+)",skillCheck:{stat:"reflex",difficulty:9},outcome:e=>e?{message:"Legendary takedown! You zero the psycho.",rewards:{eddies:2e3,rep:50,xp:500}}:{message:"Bad idea. You get absolutely wrecked.",penalties:{health:90,injury:!0}}}]},{id:"drive_by",title:"DRIVE-BY SHOOTING",description:"A Tyger Claw bike speeds past, spraying bullets at a nearby shop.",theme:"intense",options:[{text:"Take cover",outcome:C("You survive unscathed.")},{text:"Return fire (Reflex 6+)",skillCheck:{stat:"reflex",difficulty:6},outcome:e=>e?{message:"You hit the tire. The bike crashes.",rewards:{rep:20,xp:50}}:{message:"You draw attention to yourself and take a hit.",penalties:{health:20}}}]},{id:"hostage_situation",title:"HOSTAGE SITUATION",description:'A desperate goner is holding a corpo at gunpoint. "I just want my severance!"',theme:"intense",options:[{text:"Walk away",outcome:C("Not your circus.")},{text:"Negotiate (Cool 7+)",skillCheck:{stat:"cool",difficulty:7},outcome:e=>e?{message:"You talk him down. The corpo runs, dropping a credchip.",rewards:{eddies:1e3,rep:10}}:{message:"He panics and shoots. You get hit in the crossfire.",penalties:{health:30}}}]},{id:"bomb_threat",title:"TICKING PACKAGE",description:"You find a bag beeping rhythmically under a bench.",theme:"intense",options:[{text:"Run away",outcome:C("BOOM. You are safe, but the bench is gone.")},{text:"Disarm (Tech 8+)",skillCheck:{stat:"tech",difficulty:8},outcome:e=>e?{message:"Wire cut. Crisis averted. NCPD wires a reward.",rewards:{eddies:600,rep:15}}:{message:"You cut the wrong wire. It blows up in your face.",penalties:{health:60,injury:!0}}}]},{id:"corpo_hit",title:"CORPORATE HIT",description:"Two suits with silenced pistols are cornering a woman in an alley.",theme:"intense",options:[{text:"Ignore it",outcome:C("Business is business.")},{text:"Intervene (Reflex 8+)",skillCheck:{stat:"reflex",difficulty:8},outcome:e=>e?{message:"You drop the suits. The woman is a BioTechnica researcher. She pays you.",rewards:{eddies:1200,rep:10}}:{message:"Professional killers don't miss. You take a bullet.",penalties:{health:50}}}]},{id:"gang_war",title:"TURF WAR",description:"Maelstrom and Valentinos are shooting it out in the intersection.",theme:"intense",options:[{text:"Detour",outcome:C("You take the long way around.")},{text:"Loot bodies (Cool 6+)",skillCheck:{stat:"cool",difficulty:6},outcome:e=>e?{message:"You scavenge weapons from the fallen while they reload.",rewards:{eddies:300,xp:40}}:{message:"You get caught in the crossfire.",penalties:{health:30}}}]},{id:"sniper",title:"SNIPER ALARM",description:"A red laser dot appears on your chest.",theme:"intense",options:[{text:"Duck!",outcome:C("A bullet cracks the wall behind you. Close one.")},{text:"Stand still",outcome:N("You get shot. Obviously.",{health:50})}]},{id:"mad_dog",title:"CYBER-HOUND",description:"A military-grade cyber-hound has escaped and is growling at you.",theme:"intense",options:[{text:"Back away slowly",outcome:C("It loses interest and chases a rat.")},{text:"Hack it (Tech 6+)",skillCheck:{stat:"tech",difficulty:6},outcome:e=>e?{message:"You shut it down. Valuable salvage.",rewards:{eddies:400}}:{message:"It bites your leg.",penalties:{health:25}}}]},{id:"acid_rain",title:"ACID RAIN STORM",description:"The sky turns yellow. Heavy acid rain begins to fall.",theme:"intense",options:[{text:"Find shelter",outcome:C("You wait it out in a noodle shop.")},{text:"Keep moving",outcome:N("Your skin burns.",{health:15})}]},{id:"rogue_ai_cab",title:"ROGUE DELAMAIN",description:'A Delamain cab is crashing into stalls. "BEEP BEEP MOTHERF***ER!"',theme:"cyberpunk",options:[{text:"Stay back",outcome:C("It crashes into a wall.")},{text:"Reset Core (Tech 5+)",skillCheck:{stat:"tech",difficulty:5},outcome:e=>e?{message:"AI reset. Delamain HQ sends a bonus.",rewards:{eddies:500,xp:50}}:{message:"It shocks you.",penalties:{health:10}}}]},{id:"netrunner_duel",title:"NETRUNNER DUEL",description:"Two netrunners are fried in their chairs. One is still twitching.",theme:"cyberpunk",options:[{text:"Jack out the survivor",outcome:O("You save him. He transfers some credits.",{eddies:200})},{text:"Loot their decks",outcome:O("You steal a rare daemon chip.",{eddies:300,xp:20})},{text:"Leave them",outcome:C("Not getting involved in ICE wars.")}]},{id:"bd_addict",title:"BD OVERDOSE",description:"A junkie is seizing, foaming at the mouth with a wreath on.",theme:"cyberpunk",options:[{text:"Remove the wreath",outcome:O('He gasps and wakes up. "I saw god..."',{rep:2})},{text:"Call Trauma Team",outcome:C("Subscription expired. They don't come.")},{text:"Walk away",outcome:C("Another city casualty.")}]},{id:"corpo_recruiter",title:"ARASAKA RECRUITER",description:'A suit hands you a card. "You have potential. Sign here for a lifetime contract."',theme:"corpo",options:[{text:"Reject",outcome:C("You tear up the card. Felt good.",{rep:1})},{text:"Sign up",outcome:O("You sell your soul. You get some eddies but feel dirty.",{eddies:1e3,rep:-10})}]},{id:"data_shard",title:"LOST SHARD",description:"You find an encrypted shard on the ground.",theme:"cyberpunk",options:[{text:"Leave it",outcome:C("Probably malware.")},{text:"Decrypt (Tech 6+)",skillCheck:{stat:"tech",difficulty:6},outcome:e=>e?{message:"It contains banking data! Score.",rewards:{eddies:800,xp:50}}:{message:"Virus! It fries your optics.",penalties:{health:10,eddies:50}}}]},{id:"drone_race",title:"DRONE RACE",description:"Illegal drone racers zip past. One crashes near you.",theme:"cyberpunk",options:[{text:"Steal parts",outcome:O("You grab a high-speed motor.",{eddies:150})},{text:"Fix it (Tech 4+)",skillCheck:{stat:"tech",difficulty:4},outcome:e=>e?{message:"Racer thanks you with a tip.",rewards:{eddies:200}}:{message:"You break it further.",penalties:{rep:-1}}}]},{id:"malfunctioning_implant",title:"IMPLANT REJECTION",description:"Your arm starts twitching uncontrollably. Firmware update required.",theme:"cyberpunk",options:[{text:"Reboot system",outcome:C("It takes 5 minutes, but it fixes itself.")},{text:"Hit it",outcome:N("Ouch. That hurt.",{health:5})}]},{id:"rogue_ad",title:"AGGRESSIVE ADVERTISING",description:'An ad-bot grabs your arm. "BUY REAL WATER! 99% H2O!"',theme:"cyberpunk",options:[{text:"Pull away",outcome:C("It lets go.")},{text:"Punch it",outcome:O("You dent the chassis. It beeps sadly.",{xp:5})}]},{id:"crypto_miner",title:"HIDDEN MINER",description:"You notice your deck is running hot. Someone installed a background miner on you.",theme:"cyberpunk",options:[{text:"Purge it",outcome:C("You delete the malware.")},{text:"Trace it (Tech 7+)",skillCheck:{stat:"tech",difficulty:7},outcome:e=>e?{message:"You reverse the connection and steal their wallet.",rewards:{eddies:600}}:{message:"They detect you and brick your comms for an hour.",penalties:{rep:-2}}}]},{id:"tech_support",title:"TECH SUPPORT SCAM",description:'You get a call. "Hello sir, your Kiroshi has a virus. Please send 500 eddies."',theme:"cyberpunk",options:[{text:"Hang up",outcome:C("Scammers.")},{text:"Send money",cost:500,outcome:N("You idiot.")},{text:"Counter-hack (Tech 5+)",skillCheck:{stat:"tech",difficulty:5},outcome:e=>e?{message:"You fry their modem.",rewards:{xp:50,rep:5}}:{message:"They hang up."}}]},{id:"street_beggar",title:"WAR VETERAN",description:'A homeless vet asks for spare change. "Lost my legs in the Corporate War."',theme:"gang",options:[{text:"Give 10€",cost:10,outcome:O("He blesses you.",{rep:1})},{text:"Walk past",outcome:C("You ignore him.")}]},{id:"mugging",title:"ALLEY MUGGING",description:"A punk with a knife demands your eddies.",theme:"gang",options:[{text:"Give 100€",cost:100,outcome:C("You pay the coward's tax.",{},{rep:-5})},{text:"Refuse (Cool 4+)",skillCheck:{stat:"cool",difficulty:4},outcome:e=>e?{message:"You laugh. He runs.",rewards:{rep:5}}:{message:"He cuts you.",penalties:{health:20}}},{text:"Fight (Reflex 4+)",skillCheck:{stat:"reflex",difficulty:4},outcome:e=>e?{message:"KO.",rewards:{xp:30}}:{message:"Ouch.",penalties:{health:15}}}]},{id:"tagging",title:"GRAFFITI ARTIST",description:"A kid is tagging a Tyger Claw wall.",theme:"gang",options:[{text:"Warn him",outcome:C("He runs before the gang arrives. Good deed.",{rep:2})},{text:"Help him",outcome:O("You add your own tag. Art!",{rep:5})},{text:"Ignore",outcome:C("Not your business.")}]},{id:"street_race_invite",title:"RACE CHALLENGE",description:'A racer revs his engine at you. "Wanna race for pinks?"',theme:"gang",options:[{text:"Decline",outcome:C("You have work to do.")},{text:"Race (Reflex 8+)",skillCheck:{stat:"reflex",difficulty:8},outcome:e=>e?{message:"You smoke him! He pays up.",rewards:{eddies:1e3,rep:20}}:{message:"You crash. Badly.",penalties:{health:40,eddies:100}}}]},{id:"drug_deal",title:"DRUG DEAL GONE WRONG",description:"You stumble upon a deal. Everyone draws guns.",theme:"gang",options:[{text:"Back away slowly",outcome:C("They let you leave.")},{text:"Attack (Reflex 7+)",skillCheck:{stat:"reflex",difficulty:7},outcome:e=>e?{message:"You clear the room and take the stash.",rewards:{eddies:800,xp:80}}:{message:"Too many of them.",penalties:{health:50}}}]},{id:"corpo_shakedown",title:"CORPO SHAKEDOWN",description:"Militech soldiers are harassing a vendor.",theme:"corpo",options:[{text:"Walk away",outcome:C("You keep your head down.")},{text:"Intervene (Cool 8+)",skillCheck:{stat:"cool",difficulty:8},outcome:e=>e?{message:"You flash a fake badge. They leave.",rewards:{rep:15}}:{message:"They beat you with batons.",penalties:{health:30}}}]},{id:"food_stall",title:"MYSTERY MEAT",description:'A street vendor offers you a "fresh" skewer. It glows slightly.',theme:"gang",options:[{text:"Eat it (5€)",cost:5,outcome:e=>Math.random()>.5?{message:"Delicious! You feel energized.",rewards:{health:10}}:{message:"Food poisoning.",penalties:{health:10}}},{text:"Pass",outcome:C("You choose life.")}]},{id:"lost_tourist",title:"LOST TOURIST",description:'A corpo from out of town asks for directions to "The Afterlife".',theme:"funny",options:[{text:"Give directions",outcome:C("He thanks you.",{rep:1})},{text:"Send him to a scav haunt",outcome:O("He walks right into a trap. You monster.",{eddies:50,rep:-5})},{text:"Ignore",outcome:C("Tourists.")}]},{id:"joytoy_trouble",title:"JOYTOY DISPUTE",description:"A joytoy is arguing with a client who refuses to pay.",theme:"gang",options:[{text:"Help the joytoy (Intimidate)",skillCheck:{stat:"cool",difficulty:5},outcome:e=>e?{message:"Client pays up and runs. Joytoy thanks you.",rewards:{rep:5}}:{message:"Client pulls a gun.",penalties:{health:20}}},{text:"Walk away",outcome:C("City life.")}]},{id:"dumpster_diving",title:"GLOWING DUMPSTER",description:"A dumpster in the alley is glowing orange.",theme:"gang",options:[{text:"Investigate",outcome:O("It was a legendary weapon component!",{eddies:200,xp:10})},{text:"Ignore",outcome:C("Probably radioactive.")}]},{id:"rain_slick",title:"SLIPPERY STREET",description:"You slip on an oil slick.",theme:"funny",options:[{text:"Recover (Reflex 3+)",skillCheck:{stat:"reflex",difficulty:3},outcome:e=>e?{message:"Ninja recovery.",rewards:{xp:5}}:{message:"Faceplant.",penalties:{health:1}}},{text:"Fall",outcome:N("Oof.",{health:2})}]},{id:"rat_king",title:"RAT KING",description:"A swarm of rats tied together by their tails blocks the path.",theme:"weird",options:[{text:"Burn it",outcome:O("Fire solves everything.",{xp:10})},{text:"Run",outcome:C("Nope nope nope.")}]},{id:"broken_lift",title:"BROKEN ELEVATOR",description:"You are stuck in an elevator with bad muzak.",theme:"funny",options:[{text:"Wait",outcome:C("It opens eventually.")},{text:"Force doors (Tech 4+)",skillCheck:{stat:"tech",difficulty:4},outcome:e=>e?{message:"Freedom!",rewards:{xp:10}}:{message:"You strain a muscle.",penalties:{health:5}}}]},{id:"lucky_find",title:"LUCKY FIND",description:"You find a credchip stuck in a drain.",theme:"gang",options:[{text:"Fish it out",outcome:O("Got it!",{eddies:50})},{text:"Leave it",outcome:C("Not worth the grime.")}]},{id:"biker_nod",title:"FELLOW BIKER",description:"A nomad on a bike nods at you at a red light.",theme:"gang",options:[{text:"Nod back",outcome:O("Respect.",{rep:2})},{text:"Rev engine",outcome:O("He revs back. Nice.",{rep:3})}]},{id:"cyber_beggar_2",title:"GLITCHED BEGGAR",description:'A beggar is repeating "Spare a... Spare a... Spare a..." in a loop.',theme:"cyberpunk",options:[{text:"Reboot him (Tech 3+)",skillCheck:{stat:"tech",difficulty:3},outcome:e=>e?{message:'He reboots. "Thanks choom."',rewards:{rep:5}}:{message:"You make it worse. He starts screaming.",penalties:{rep:-1}}},{text:"Walk away",outcome:C("Creepy.")}]},{id:"neon_sign",title:"FALLING SIGN",description:"A neon sign above you snaps loose!",theme:"intense",options:[{text:"Dodge (Reflex 5+)",skillCheck:{stat:"reflex",difficulty:5},outcome:e=>e?{message:"Missed you by an inch.",rewards:{xp:20}}:{message:"Bonk.",penalties:{health:20}}},{text:"Cover head",outcome:N("It hurts.",{health:15})}]},{id:"cat_rescue",title:"CAT IN TREE",description:"A cyber-cat is stuck in a holographic tree.",theme:"funny",options:[{text:"Climb up",outcome:O("You save the cat. It scratches you, but you feel good.",{rep:5,health:-1})},{text:"Ignore",outcome:C("Cats always land on their feet.")}]},{id:"street_preacher",title:"DOOMSDAY PREACHER",description:'A man yells "THE NET IS THE DEVIL!"',theme:"weird",options:[{text:"Argue",outcome:C("You waste 10 minutes arguing. He smells.",{rep:-1})},{text:"Agree",outcome:O("He gives you a pamphlet.",{xp:5})},{text:"Walk away",outcome:C("Crazy people.")}]},{id:"corpo_lunch",title:"DROPPED LUNCH",description:"A corpo dropped their fancy sushi lunch.",theme:"funny",options:[{text:"Eat it",outcome:O("Real fish! Tasty.",{health:10})},{text:"Return it",outcome:O("Corpo looks disgusted but tips you.",{eddies:20})},{text:"Step on it",outcome:O("Take that, Arasaka.",{rep:1})}]},{id:"atm_glitch",title:"ATM GLITCH",description:"An ATM is spitting out bills!",theme:"cyberpunk",options:[{text:"Grab cash",outcome:O("You grab what you can before it stops.",{eddies:300})},{text:"Walk away",outcome:C("Not getting flagged by security.")}]},{id:"rogue_roomba",title:"KILLER VACUUM",description:"A cleaning bot has taped a knife to itself.",theme:"funny",options:[{text:"Kick it",outcome:O("It flips over, wheels spinning helplessly.",{xp:10})},{text:"Run",outcome:C("It chases you slowly.")}]},{id:"fashion_police",title:"FASHION POLICE",description:'A stylist critiques your outfit. "So last season."',theme:"funny",options:[{text:"Insult back (Cool 4+)",skillCheck:{stat:"cool",difficulty:4},outcome:e=>e?{message:"You roast their shoes. They cry.",rewards:{rep:5}}:{message:"You stutter. Weak.",penalties:{rep:-2}}},{text:"Ignore",outcome:C("Haters gonna hate.")}]},{id:"wet_floor",title:"WET FLOOR",description:"There is no sign. Just a puddle.",theme:"funny",options:[{text:"Walk carefully",outcome:C("Safe.")},{text:"Run",outcome:N("You slip.",{health:2})}]},{id:"mystery_button",title:"MYSTERY BUTTON",description:'A button on a wall says "DO NOT PRESS".',theme:"weird",options:[{text:"Press it",outcome:e=>Math.random()>.5?{message:"Confetti explodes!",rewards:{xp:5}}:{message:"You get shocked.",penalties:{health:5}}},{text:"Don't press",outcome:C("Boring.")}]},{id:"lost_drone",title:"LOST DRONE",description:"A small drone is hovering, looking lost.",theme:"cyberpunk",options:[{text:"Check logs (Tech 3+)",skillCheck:{stat:"tech",difficulty:3},outcome:e=>e?{message:"You send it home. Owner wires credits.",rewards:{eddies:50}}:{message:"Encrypted."}},{text:"Smash it",outcome:O("Scrap parts.",{eddies:20})},{text:"Ignore",outcome:C("It beeps sadly.")}]},{id:"street_fight",title:"FIGHT CLUB",description:'An illegal street fight circle. "Care to join?"',theme:"intense",options:[{text:"Fight (Reflex 6+)",skillCheck:{stat:"reflex",difficulty:6},outcome:e=>e?{message:"You win!",rewards:{eddies:200,rep:10}}:{message:"You get knocked out.",penalties:{health:30}}},{text:"Bet 50€",cost:50,outcome:e=>Math.random()>.5?{message:"Your fighter won!",rewards:{eddies:100}}:{message:"Your fighter lost."}},{text:"Watch",outcome:C("Entertaining.")}]},{id:"corpo_drunk",title:"DRUNK SALARYMAN",description:"A drunk corpo is vomiting in the gutter.",theme:"corpo",options:[{text:"Rob him",outcome:O("Easy pickings.",{eddies:150,rep:-5})},{text:"Help him",outcome:O("He gives you his watch.",{eddies:50,rep:5})},{text:"Ignore",outcome:C("Pathetic.")}]},{id:"holo_ad_glitch",title:"SEIZURE AD",description:"A holographic ad is flashing rapidly.",theme:"cyberpunk",options:[{text:"Look away",outcome:C("Saved your eyes.")},{text:"Stare",outcome:N("Headache.",{health:2})}]},{id:"rat_race",title:"RAT RACE",description:"People are betting on racing rats.",theme:"funny",options:[{text:'Bet on "Speedy" (10€)',cost:10,outcome:e=>Math.random()>.5?{message:"Speedy wins!",rewards:{eddies:30}}:{message:"Speedy was eaten."}},{text:"Walk away",outcome:C("Gross.")}]},{id:"abandoned_bike",title:"ABANDONED BIKE",description:"A nice bike, unlocked.",theme:"gang",options:[{text:"Steal it",outcome:O("You strip it for parts.",{eddies:300,rep:-2})},{text:"Leave it",outcome:C("Probably bait.")}]},{id:"ncpd_scan",title:"RANDOM SCAN",description:'NCPD drone scans you. "Citizen, halt."',theme:"intense",options:[{text:"Halt",outcome:C("Scan complete. You are clean.")},{text:"Run",outcome:N("They fine you.",{eddies:50})}]},{id:"vendit_hack",title:"VENDIT HACK",description:"A vending machine is unlocked.",theme:"tech",options:[{text:"Hack (Tech 2+)",skillCheck:{stat:"tech",difficulty:2},outcome:e=>e?{message:"Free drinks!",rewards:{eddies:20,health:5}}:{message:"Alarm triggers.",penalties:{rep:-2}}},{text:"Ignore",outcome:C("Not thirsty.")}]},{id:"street_doc",title:"STREET DOC",description:"A shady doctor offers cheap stims.",theme:"gang",options:[{text:"Buy Stims (50€)",cost:50,outcome:O("You feel great!",{health:50})},{text:"Decline",outcome:C("Sketchy.")}]},{id:"religous_cult",title:"TECHNO NECROMANCERS",description:"Cultists from Alpha Centauri want a donation.",theme:"weird",options:[{text:"Donate 5€",cost:5,outcome:O("They chant your name.",{xp:5})},{text:"Mock them",outcome:C("They curse your hard drive.")}]},{id:"sewer_gator",title:"SEWER RUMBLE",description:"Something big is moving under the manhole.",theme:"weird",options:[{text:"Open it",outcome:N("A mutant gator bites you!",{health:20})},{text:"Walk away",outcome:C("Nope.")}]},{id:"free_stuff",title:"FREE BOX",description:'A box says "FREE".',theme:"funny",options:[{text:"Look inside",outcome:O("It's just old cables.",{xp:2})},{text:"Ignore",outcome:C("Junk.")}]},{id:"broken_bot",title:"SAD ROBOT",description:"A robot is crying oil tears.",theme:"funny",options:[{text:"Comfort it",outcome:O("It beeps happily.",{rep:2})},{text:"Kick it",outcome:N("It shocks you.",{health:5})}]},{id:"laser_tag",title:"LASER POINTER",description:"Someone is pointing a laser at you.",theme:"funny",options:[{text:"Duck",outcome:C("Just kids playing.")},{text:"Yell",outcome:C("They run away laughing.")}]},{id:"lost_shoe",title:"SINGLE SHOE",description:"A single high-end sneaker lies on the road.",theme:"weird",options:[{text:"Take it",outcome:O("Maybe you find the other one?",{eddies:10})},{text:"Leave it",outcome:C("Useless.")}]}];const k=new class{spawnTimer=null;checkTimer=null;MIN_SPAWN_TIME=6e4;MAX_SPAWN_TIME=9e4;ENCOUNTER_DURATION_MIN=12e4;ENCOUNTER_DURATION_MAX=24e4;MAX_ENCOUNTERS=3;constructor(){this.startSpawning(2e4),this.startExpirationCheck()}startSpawning(e){const t=e??Math.floor(Math.random()*(this.MAX_SPAWN_TIME-this.MIN_SPAWN_TIME+1))+this.MIN_SPAWN_TIME;this.spawnTimer=window.setTimeout(()=>{this.spawnEncounter(),this.startSpawning()},t)}startExpirationCheck(){this.checkTimer=window.setInterval(()=>{const e=c.get(),t=Date.now();e.activeEncounters.forEach(e=>{t>e.expiresAt&&x(e.id)})},1e3)}spawnEncounter(){const e=c.get();if(e.activeEncounters.length>=this.MAX_ENCOUNTERS)return;const t=L[Math.floor(Math.random()*L.length)],n=[{x:65,y:40,width:25,height:25},{x:25,y:45,width:28,height:28},{x:80,y:60,width:25,height:25},{x:88,y:15,width:20,height:30}];e.activeEncounters.forEach(e=>{n.push({x:e.x,y:e.y,width:12,height:12})});let s=0,i=0,a=0;do{s=Math.floor(80*Math.random())+10,i=Math.floor(70*Math.random())+10;if(!n.some(e=>{const t=e.width/2,n=e.height/2,a=s-2,o=s+2,r=i-2,l=i+2,c=e.x-t,d=e.x+t,p=e.y-n,u=e.y+n;return!(o<c||a>d||l<p||r>u)}))break;a++}while(a<50);if(a>=50)return;const o=Math.floor(Math.random()*(this.ENCOUNTER_DURATION_MAX-this.ENCOUNTER_DURATION_MIN+1))+this.ENCOUNTER_DURATION_MIN;((e,t,n,s)=>{const i=c.get(),a=Date.now().toString()+Math.random().toString().slice(2,6),o={id:a,encounterId:e,x:t,y:n,expiresAt:Date.now()+s};c.setKey("activeEncounters",[...i.activeEncounters,o])})(t.id,s,i,o)}resolveEncounter(e,t){const n=L.find(t=>t.id===e);if(!n)return{message:"Error: Encounter not found",success:!1,effects:{}};const s=n.options[t],i=c.get(),a=i.members,o={};if(s.cost&&i.eddies<s.cost)return{message:"Not enough eddies!",success:!1,effects:{}};let r=!0;if(s.skillCheck){const e=a.find(e=>1===e.id),t=(e?e.stats:{cool:0,reflex:0})["tech"===s.skillCheck.stat?"cool":s.skillCheck.stat]||0;r=Math.floor(10*Math.random())+1+t>=s.skillCheck.difficulty+5}const l=s.outcome(r,a);if(!s.skillCheck){const e=l.penalties&&Object.keys(l.penalties).length>0,t=l.rewards&&Object.keys(l.rewards).length>0;e&&!t&&(r=!1)}if(s.cost&&(o.cost=s.cost,d(-s.cost)),l.rewards&&(o.rewards={},l.rewards.eddies&&(o.rewards.eddies=l.rewards.eddies,d(l.rewards.eddies)),l.rewards.rep&&(o.rewards.rep=l.rewards.rep,p(l.rewards.rep)),l.rewards.xp&&(o.rewards.xp=l.rewards.xp),l.rewards.health)){const e=a.filter(e=>e.health<e.maxHealth);if(e.length>0){o.rewards.health=l.rewards.health;const t=e[Math.floor(Math.random()*e.length)];f(t.id,-l.rewards.health),o.rewards.targetName=t.name}}if(l.penalties&&(o.penalties={},l.penalties.eddies&&(o.penalties.eddies=l.penalties.eddies,d(-l.penalties.eddies)),l.penalties.rep&&(o.penalties.rep=l.penalties.rep,p(l.penalties.rep)),l.penalties.health)){const e=a.filter(e=>!e.injured&&e.health>0);if(e.length>0){o.penalties.health=l.penalties.health;const t=e[Math.floor(Math.random()*e.length)];f(t.id,l.penalties.health),o.penalties.targetName=t.name}}return{message:l.message,success:r,effects:o}}stop(){null!==this.spawnTimer&&(window.clearTimeout(this.spawnTimer),this.spawnTimer=null),null!==this.checkTimer&&(window.clearInterval(this.checkTimer),this.checkTimer=null)}};class D{audioContext;musicVolume=.15;sfxVolume=.4;musicPlaying=!1;musicEnabled=!0;sfxEnabled=!0;currentSource=null;currentGainNode=null;loadedBuffers={};musicTracks=["assets/casualty-loop-1.ogg","assets/casualty-loop-2.ogg","assets/casualty-loop-3.ogg"];constructor(){const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e}async loadMusicTrack(e){if(this.loadedBuffers[e])return this.loadedBuffers[e];try{const t=await fetch(e),n=await t.arrayBuffer(),s=await this.audioContext.decodeAudioData(n);return this.loadedBuffers[e]=s,s}catch(t){return null}}async playRandomTrack(){if(!this.musicPlaying)return;const e=Math.floor(Math.random()*this.musicTracks.length),t=this.musicTracks[e],n=await this.loadMusicTrack(t);if(!n)return;if(this.currentSource){this.currentSource.onended=null;try{this.currentSource.stop()}catch(a){}this.currentSource=null}const s=this.audioContext.createBufferSource(),i=this.audioContext.createGain();s.buffer=n,i.gain.setValueAtTime(this.musicVolume,this.audioContext.currentTime),s.connect(i),i.connect(this.audioContext.destination),this.currentSource=s,this.currentGainNode=i,s.onended=()=>{this.musicPlaying&&this.playRandomTrack()},s.start(0)}async startBackgroundMusic(){this.musicPlaying||("suspended"===this.audioContext.state&&await this.audioContext.resume(),this.musicPlaying=!0,await this.playRandomTrack())}stopBackgroundMusic(){this.musicPlaying=!1,this.currentSource&&(this.currentSource.stop(),this.currentSource=null),this.currentGainNode=null}playClick(){if(!this.sfxEnabled)return;"suspended"===this.audioContext.state&&this.audioContext.resume();const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sine",n.frequency.setValueAtTime(800,t),n.frequency.exponentialRampToValueAtTime(400,t+.05),s.gain.setValueAtTime(.3*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.1),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.1)}playPanelOpen(){if(!this.sfxEnabled)return;"suspended"===this.audioContext.state&&this.audioContext.resume();const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="square",n.frequency.setValueAtTime(200,t),n.frequency.exponentialRampToValueAtTime(600,t+.15),s.gain.setValueAtTime(.2*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.2),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.2)}playPanelClose(){if(!this.sfxEnabled)return;"suspended"===this.audioContext.state&&this.audioContext.resume();const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="square",n.frequency.setValueAtTime(600,t),n.frequency.exponentialRampToValueAtTime(200,t+.15),s.gain.setValueAtTime(.2*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.2),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.2)}playMissionComplete(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime;[440,554.37,659.25].forEach((n,s)=>{const i=e.createOscillator(),a=e.createGain();i.type="triangle",i.frequency.setValueAtTime(n,t+.1*s),a.gain.setValueAtTime(.3*this.sfxVolume,t+.1*s),a.gain.exponentialRampToValueAtTime(.01,t+.1*s+.3),i.connect(a),a.connect(e.destination),i.start(t+.1*s),i.stop(t+.1*s+.3)})}playLevelUp(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime;[440,554.37,659.25,880].forEach((n,s)=>{const i=e.createOscillator(),a=e.createGain();i.type="sawtooth",i.frequency.setValueAtTime(n,t+.08*s),a.gain.setValueAtTime(.4*this.sfxVolume,t+.08*s),a.gain.exponentialRampToValueAtTime(.01,t+.08*s+.4),i.connect(a),a.connect(e.destination),i.start(t+.08*s),i.stop(t+.08*s+.4)})}playInjury(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sawtooth",n.frequency.setValueAtTime(800,t),n.frequency.exponentialRampToValueAtTime(100,t+.3),s.gain.setValueAtTime(.5*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.3),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.3)}playPurchase(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime;[600,800].forEach((n,s)=>{const i=e.createOscillator(),a=e.createGain();i.type="sine",i.frequency.setValueAtTime(n,t+.1*s),a.gain.setValueAtTime(.3*this.sfxVolume,t+.1*s),a.gain.exponentialRampToValueAtTime(.01,t+.1*s+.15),i.connect(a),a.connect(e.destination),i.start(t+.1*s),i.stop(t+.1*s+.15)})}playHeal(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sine",n.frequency.setValueAtTime(300,t),n.frequency.exponentialRampToValueAtTime(900,t+.4),s.gain.setValueAtTime(.3*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.4),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.4)}playUpgrade(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="square",n.frequency.setValueAtTime(200,t),n.frequency.exponentialRampToValueAtTime(1200,t+.3),s.gain.setValueAtTime(.3*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.3),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.3)}playError(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sawtooth",n.frequency.setValueAtTime(150,t),s.gain.setValueAtTime(.3*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.2),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.2)}playHover(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sine",n.frequency.setValueAtTime(400,t),n.frequency.exponentialRampToValueAtTime(600,t+.05),s.gain.setValueAtTime(.1*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.05),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.05)}playAlert(){if(!this.sfxEnabled)return;const e=this.audioContext,t=e.currentTime,n=e.createOscillator(),s=e.createGain();n.type="sine",n.frequency.setValueAtTime(1200,t),n.frequency.exponentialRampToValueAtTime(600,t+.3),s.gain.setValueAtTime(.5*this.sfxVolume,t),s.gain.exponentialRampToValueAtTime(.01,t+.3),n.connect(s),s.connect(e.destination),n.start(t),n.stop(t+.3)}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(100,e))/100,this.currentGainNode&&this.currentGainNode.gain.setValueAtTime(this.musicVolume,this.audioContext.currentTime)}setSfxVolume(e){this.sfxVolume=Math.max(0,Math.min(100,e))/100}getMusicVolume(){return Math.round(100*this.musicVolume)}getSfxVolume(){return Math.round(100*this.sfxVolume)}setMusicEnabled(e){this.musicEnabled=e,!e&&this.musicPlaying?this.stopBackgroundMusic():e&&!this.musicPlaying&&this.startBackgroundMusic()}setSfxEnabled(e){this.sfxEnabled=e}isMusicEnabled(){return this.musicEnabled}isSfxEnabled(){return this.sfxEnabled}}const H=new D,G=Object.freeze(Object.defineProperty({__proto__:null,AudioManager:D,audioManager:H},Symbol.toStringTag,{value:"Module"}));class P{static get parts(){return{hair:[["   .///////.   ","  //       \\\\  "," //  _____  \\\\ "," |  /     \\  | "],["   xxxxxxxxx   ","  xx       xx  "," xx  _____  xx "," |  /     \\  | "],["   !!!!!!!!!   ","  !!       !!  "," !!  _____  !! "," |  /     \\  | "],["   #########   ","  ##       ##  "," ##  _____  ## "," |  /     \\  | "],["   ^^^^^^^^^   ","  ^^       ^^  "," ^^  _____  ^^ "," |  /     \\  | "]],eyes:[" |   O   O   | "," |   -   -   | "," |   @   @   | "," |   X   X   | "," |   >   <   | "],nose:[" |     ^     | "," |     |     | "," |     .     | "," |     L     | "," |     ~     | "],mouth:[" |   _____   | "," |   =====   | "," |   ~~~~~   | "," |   \\___/   | "," |   [___]   | "],chin:["  \\  \\___/  /  ","   \\_______/   ","    \\_____/    ","     \\___/     ","      \\_/      "]}}static get names(){return["Viper","Ghost","Chrome","Spike","Nova","Razer","Shadow","Blitz","Zero","Hex","Neon","Pulse","Echo","Flux","Jinx","Raven","Steel","Volt","Cipher","Dax"]}static get descriptions(){return["Ex-Corpo security, tired of the leash.","Street kid with a chip on their shoulder.","Nomad drifter looking for a crew.","Tech-obsessed netrunner with twitchy fingers.","Biker veteran who's seen it all.","Underground pit fighter seeking glory.","Disgraced medic with steady hands.","Smuggler who knows every back alley.","Sniper with a cybernetic eye.","Demolitions expert who loves loud noises."]}static generatePortrait(){const e=this.parts;return{art:[...e.hair[Math.floor(Math.random()*e.hair.length)],e.eyes[Math.floor(Math.random()*e.eyes.length)],e.nose[Math.floor(Math.random()*e.nose.length)],e.mouth[Math.floor(Math.random()*e.mouth.length)],e.chin[Math.floor(Math.random()*e.chin.length)]].join("\n"),name:this.names[Math.floor(Math.random()*this.names.length)]+"-"+Math.floor(99*Math.random()),description:this.descriptions[Math.floor(Math.random()*this.descriptions.length)]}}static getGangLogo(e){return{"IRON SKULLS":"\n   .---.\n  /  _  \\\n |  (o)  |\n  \\  ^  /\n   '---'\n            ","NEON DRAGONS":"\n    /\\\n   ( o.o)\n    > ^ <\n   /  -  \\\n            ","CYBER PUNKS":"\n   [###]\n   |o o|\n   | - |\n   \\___/\n            "}[e]||"\n   /---\\\n   | ? |\n   \\---/\n        "}}class U{container;hudContainer;modalContainer;activeTab="missions";lastActiveMissions=[];lastAvailableMissions=[];lastTerritories=[];mapInterface;constructor(){this.container=document.getElementById("ui-layer"),this.hudContainer=document.createElement("div"),this.modalContainer=document.createElement("div"),this.modalContainer.className="pointer-events-none",this.container.appendChild(this.hudContainer),this.container.appendChild(this.modalContainer),this.setupHUD(),this.setupListeners(),this.setupStoreSubscription(),this.startFlavorTextRotation(),this.createScanlines(),this.setupGlobalClickEffects(),this.mapInterface=new w}createScanlines(){const e=document.createElement("div");e.className="scanlines",document.body.appendChild(e);const t=document.createElement("div");t.className="crt-vignette",document.body.appendChild(t)}setupGlobalClickEffects(){document.addEventListener("click",e=>{this.createClickParticle(e.clientX,e.clientY)})}createClickParticle(e,t){const n=document.createElement("div");n.className="click-particle",n.style.left=`${e}px`,n.style.top=`${t}px`,document.body.appendChild(n);const s=20*(Math.random()-.5),i=20*(Math.random()-.5);n.style.setProperty("--x-offset",`${s}px`),n.style.setProperty("--y-offset",`${i}px`),setTimeout(()=>{n.remove()},500)}showFloatingText(e,t,n,s="text-white"){const i=document.createElement("div");i.className=`floating-text ${s} font-cyber font-bold text-xl absolute pointer-events-none z-[100]`,i.textContent=e,i.style.left=`${t}px`,i.style.top=`${n}px`,document.body.appendChild(i);i.animate([{transform:"translate(0, 0) scale(1)",opacity:1},{transform:"translate(0, 50px) scale(1.2)",opacity:0}],{duration:1e3,easing:"ease-out"}).onfinish=()=>i.remove()}setupHUD(){this.hudContainer.className="absolute top-0 left-0 w-full pointer-events-none flex flex-col z-50",this.hudContainer.innerHTML=`\n      <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b-2 border-cp-yellow pb-2 mb-0 bg-cp-black/70 -skew-x-[10deg] border-l-[10px] border-l-cp-cyan pointer-events-auto px-4 py-2 transition-all duration-300">\n        <div id="gang-name-header" class="text-xl md:text-2xl font-black text-cp-cyan ml-2 md:ml-5 skew-x-[10deg] drop-shadow-[2px_2px_var(--cp-red)] font-cyber mb-2 md:mb-0">\n          ${c.get().gangName.toUpperCase()}\n        </div>\n        <div id="resources" class="flex flex-wrap gap-3 md:gap-10 mr-2 md:mr-5 skew-x-[10deg] items-center">\n          <div class="text-sm md:text-xl font-bold text-cp-yellow uppercase flex items-center font-cyber">\n            EDDIES: <span id="hud-eddies" class="text-white ml-2">0</span>\n          </div>\n          <div class="text-sm md:text-xl font-bold text-cp-yellow uppercase flex items-center font-cyber">\n            REP: <span id="hud-rep" class="text-white ml-2">0</span>\n          </div>\n          <div class="text-sm md:text-xl font-bold text-cp-yellow uppercase flex items-center font-cyber">\n            MEMBERS: <span id="hud-members" class="text-white ml-2">0</span>\n          </div>\n          <div class="flex gap-2 ml-auto md:ml-0">\n            <button id="settings-btn" class="cyber-btn text-xs" title="Settings">⚙</button>\n            <button id="tutorial-btn" class="cyber-btn text-xs" title="Show Tutorial">?</button>\n          </div>\n        </div>\n      </header>\n      <div id="active-ops-panel" class="absolute top-20 right-4 w-64 flex flex-col gap-2 pointer-events-auto transition-all duration-300"></div>\n    `,setInterval(()=>this.updateActiveOpsPanel(),1e3),setTimeout(()=>{document.getElementById("tutorial-btn")?.addEventListener("click",()=>{H.playClick(),window.showTutorial?.()}),document.getElementById("settings-btn")?.addEventListener("click",()=>{H.playClick(),this.openSettingsPanel()})},100)}updateActiveOpsPanel(){const e=document.getElementById("active-ops-panel");if(!e)return;const t=R.getActiveOperations();if(0===t.length)return void(e.innerHTML="");const n=c.get();e.innerHTML=t.map(e=>{const t=n.territories.find(t=>t.id===e.targetTerritoryId),s=t?t.name:`TERRITORY ${e.targetTerritoryId}`,i=Math.max(0,Math.ceil((e.endTime-Date.now())/1e3)),a=e.endTime-e.startTime,r=Math.min(100,Math.max(0,100-1e3*i/a*100));let l="text-white";"ASSAULT"===e.type?l="text-red-500":"SCOUT"===e.type?l="text-cp-cyan":"RAID"===e.type&&(l="text-orange-500");let c="UNKNOWN",d="#ffffff";if("PLAYER"===e.initiatorGangId)c=n.gangName,d="#00F0FF";else{const t=o.getGangById(e.initiatorGangId);t?(c=t.name,d=t.color):c=e.initiatorGangId}let p="NEUTRAL",u="#888888";if(t)if(t.controlled)p=n.gangName,u="#00F0FF";else if(t.rivalGang){const e=o.getGangById(t.rivalGang);e?(p=e.name,u=e.color):p=t.rivalGang}return`\n            <div class="bg-black/90 border border-cp-cyan p-2 text-xs font-cyber shadow-[0_0_10px_rgba(0,0,0,0.5)] animate-fadeIn w-full md:min-w-[240px]">\n                <div class="flex justify-between mb-1">\n                    <span class="${l} font-bold text-sm">${e.type}</span>\n                    <span class="text-cp-yellow font-mono">${i}s</span>\n                </div>\n                <div class="w-full bg-gray-800 h-1 mb-2">\n                    <div class="h-full bg-cp-cyan transition-all duration-1000" style="width: ${r}%"></div>\n                </div>\n                <div class="flex justify-between items-center gap-2">\n                    <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider whitespace-nowrap">${s}</div>\n                    <div class="text-[9px] font-bold flex items-center gap-1 bg-black/50 px-1 rounded border border-gray-800">\n                        <span style="color: ${d}" class="drop-shadow-[0_0_2px_${d}]">${c}</span>\n                        <span class="text-gray-500">➜</span>\n                        <span style="color: ${u}" class="drop-shadow-[0_0_2px_${u}]">${p}</span>\n                    </div>\n                </div>\n            </div>\n        `}).join("")}openSettingsPanel(){const e=document.getElementById("settings-overlay");if(!e)return;e.classList.remove("tutorial-hidden"),H.playPanelOpen();const t=document.getElementById("music-volume"),n=document.getElementById("sfx-volume"),s=document.getElementById("music-toggle"),i=document.getElementById("sfx-toggle"),a=document.getElementById("music-volume-value"),o=document.getElementById("sfx-volume-value");if(t&&(t.value=H.getMusicVolume().toString(),a&&(a.textContent=`${H.getMusicVolume()}%`)),n&&(n.value=H.getSfxVolume().toString(),o&&(o.textContent=`${H.getSfxVolume()}%`)),s&&(s.checked=H.isMusicEnabled()),i&&(i.checked=H.isSfxEnabled()),!e._listenersAdded){e._listenersAdded=!0,document.getElementById("settings-close-btn")?.addEventListener("click",()=>{H.playPanelClose(),e.classList.add("tutorial-hidden")}),t?.addEventListener("input",e=>{const t=parseInt(e.target.value);H.setMusicVolume(t),a&&(a.textContent=`${t}%`),this.saveSettings()}),n?.addEventListener("input",e=>{const t=parseInt(e.target.value);H.setSfxVolume(t),o&&(o.textContent=`${t}%`),H.playClick(),this.saveSettings()}),s?.addEventListener("change",e=>{const t=e.target.checked;H.setMusicEnabled(t),H.playClick(),this.saveSettings()}),i?.addEventListener("change",e=>{const t=e.target.checked;H.setSfxEnabled(t),t&&H.playClick(),this.saveSettings()}),document.getElementById("export-save-btn")?.addEventListener("click",()=>{H.playClick();const e=M.exportSaveData();if(e){const t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=`bikergang_save_${Date.now()}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),this.showToast("SAVE EXPORTED","success")}else this.showToast("NO SAVE DATA","error")});const r=document.getElementById("import-save-input");document.getElementById("import-save-btn")?.addEventListener("click",()=>{H.playClick(),r?.click()}),r?.addEventListener("change",e=>{const t=e.target.files?.[0];if(t){const e=new FileReader;e.onload=e=>{const t=e.target?.result;M.importSaveData(t)?(M.preventSave(),this.showToast("SAVE IMPORTED - RELOADING","success"),setTimeout(()=>window.location.reload(),1e3)):this.showToast("IMPORT FAILED","error")},e.readAsText(t)}r.value=""});const l=document.getElementById("reset-progress-btn");l?.addEventListener("click",()=>{H.playError(),this.showResetConfirmationModal(()=>{H.playError(),this.resetGame(),e.classList.add("tutorial-hidden"),this.showToast("GAME RESET COMPLETE","success")})})}}saveSettings(){M.saveSettings({musicVolume:H.getMusicVolume(),sfxVolume:H.getSfxVolume(),musicEnabled:H.isMusicEnabled(),sfxEnabled:H.isSfxEnabled()})}resetGame(){M.forceReset(),window.location.reload()}showGangNameModal(){const e=this.createOverlay();e.style.zIndex="100000";const t=document.createElement("div");t.className="bg-cp-bg border-[3px] border-cp-cyan shadow-[0_0_60px_rgba(0,240,255,0.8)] w-[90%] max-w-[500px] flex flex-col animate-modalSlideIn pointer-events-auto";const n=c.get().gangName;t.innerHTML=`\n      <div class="bg-cp-cyan/20 border-b-2 border-cp-cyan p-5">\n        <h2 class="text-cp-cyan m-0 text-3xl drop-shadow-[0_0_10px_var(--cp-cyan)] font-cyber font-bold uppercase text-center">NAME YOUR GANG</h2>\n      </div>\n      \n      <div class="p-6">\n        <p class="text-white text-lg mb-6 font-cyber leading-relaxed border-l-4 border-cp-cyan pl-4 bg-black/30 p-4">\n          Every legend needs a name. What will the streets call your crew?\n        </p>\n        \n        <div class="mb-6">\n          <label class="text-cp-yellow font-cyber text-sm mb-2 block uppercase tracking-wider">Gang Name</label>\n          <input \n            type="text" \n            id="gang-name-input" \n            class="w-full bg-black/60 border-2 border-cp-cyan text-white font-cyber text-lg p-3 focus:outline-none focus:border-cp-yellow transition-colors"\n            placeholder="V's Gang"\n            value="${n}"\n            maxlength="30"\n          />\n          <p class="text-gray-500 text-xs mt-2 font-cyber">Max 30 characters</p>\n        </div>\n      </div>\n\n      <div class="border-t-2 border-cp-cyan p-5">\n        <button id="confirm-gang-name" class="cyber-btn w-full py-3 text-xl">CONFIRM</button>\n      </div>\n    `,e.appendChild(t),document.body.appendChild(e);const s=t.querySelector("#gang-name-input"),i=t.querySelector("#confirm-gang-name");setTimeout(()=>s?.focus(),100),s?.addEventListener("keypress",e=>{"Enter"===e.key&&i?.dispatchEvent(new Event("click"))}),i?.addEventListener("click",()=>{H.playClick();const t=s?.value.trim()||"V's Gang";var n;n=t,c.setKey("gangName",n),M.saveGame(),e.remove(),this.showToast(`GANG RENAMED: ${t}`,"success")})}showResetConfirmationModal(e){const t=this.createOverlay();t.style.zIndex="100000";const n=document.createElement("div");n.className="bg-cp-bg border-[3px] border-cp-red shadow-[0_0_60px_rgba(255,0,0,0.8)] w-[90%] max-w-[500px] flex flex-col animate-modalSlideIn pointer-events-auto",n.innerHTML=`\n      <div class="bg-cp-red/20 border-b-2 border-cp-red p-5">\n        <h2 class="text-cp-red m-0 text-3xl drop-shadow-[0_0_10px_var(--cp-red)] font-cyber font-bold uppercase text-center animate-pulse">⚠ WARNING ⚠</h2>\n      </div>\n      \n      <div class="p-6">\n        <p class="text-white text-lg mb-6 font-cyber leading-relaxed border-l-4 border-cp-red pl-4 bg-black/30 p-4">\n          This will <span class="text-cp-red font-bold">PERMANENTLY DELETE</span> <span class="text-cp-cyan font-bold">${c.get().gangName}</span> and all your progress, including:\n        </p>\n        \n        <ul class="text-gray-300 mb-6 space-y-2 font-cyber ml-4">\n          <li>• All gang members and upgrades</li>\n          <li>• All eddies and reputation</li>\n          <li>• All territories and completed missions</li>\n          <li>• All game settings</li>\n        </ul>\n\n        <p class="text-cp-yellow text-base font-cyber text-center font-bold mb-4 animate-pulse">\n          DELETE ${c.get().gangName.toUpperCase()} FOREVER?\n        </p>\n      </div>\n\n      <div class="border-t-2 border-cp-red p-5 flex gap-3">\n        <button id="cancel-reset" class="cyber-btn flex-1 py-3 text-lg bg-gray-700 hover:bg-gray-600">CANCEL</button>\n        <button id="confirm-reset" class="cyber-btn flex-1 py-3 text-lg bg-cp-red/80 hover:bg-cp-red text-white animate-pulse">DELETE EVERYTHING</button>\n      </div>\n    `,t.appendChild(n),document.body.appendChild(t),n.querySelector("#cancel-reset")?.addEventListener("click",()=>{H.playClick(),t.remove()}),n.querySelector("#confirm-reset")?.addEventListener("click",()=>{H.playClick(),t.remove(),e()})}startFlavorTextRotation(){const e=document.getElementById("flavor-text");if(!e)return;const t=()=>{e.style.opacity="0",setTimeout(()=>{const t=c.get().gangName.toUpperCase(),n=["WARNING: RELIC MALFUNCTION DETECTED","DON'T FORGET TO FEED YOUR CAT","HANAKO IS STILL WAITING AT EMBERS","NCPD WARRANT ISSUED: JAYWALKING","TRAUMA TEAM MEMBERSHIP EXPIRED","WAKE THE F*** UP, SAMURAI","KIROSHI OPTICS FIRMWARE UPDATE AVAILABLE","WEATHER UPDATE: ACID RAIN EXPECTED IN PACIFICA","MAXTAC DEPLOYED TO CITY CENTER","REMEMBER: STYLE OVER SUBSTANCE","NETWATCH IS WATCHING YOU","DELAMAIN: EXCUSE ME, BEEP BEEP","NIGHT CITY WEATHER: ACID RAIN ADVISORY IN EFFECT","ARASAKA STOCK DIPS AFTER EXECUTIVE KIDNAPPING RUMORS","MILITECH RECRUITMENT DRIVE: SIGN YOUR LIFE AWAY TODAY","TRAUMA TEAM PLATINUM: BECAUSE YOU'RE WORTH SAVING","SYNTH-MEAT PRICES SOAR: REAL BEEF NOW A LUXURY","NCPD REMINDER: LOITERING IS PUNISHABLE BY DEATH","CYBERPSYCHOSIS SYMPTOMS? REPORT YOUR NEIGHBOR NOW","KANG TAO: SMART WEAPONS FOR SMART OPERATORS","BIOTECHNICA PROMISES NEW ALGAE FLAVORS BY 2078","PETROCHEM: FUELING THE FUTURE, BURNING THE PAST","ZETA TECH: UPGRADE YOUR MIND, UPGRADE YOUR LIFE","KIROSHI OPTICS: SEE THE TRUTH, OR WHAT WE SHOW YOU","BUDGET ARMS: RELIABLE ENOUGH FOR THE STREETS","MIDNIGHT LADY: FOR WHEN YOU NEED TO FEEL SOMETHING","NICOLA: TASTE THE LOVE, IGNORE THE CHEMICALS","SPUNKY MONKEY: 100% ARTIFICIAL, 100% DELICIOUS","ALL FOODS: WE FEED THE CITY, ONE WAY OR ANOTHER","ORBITAL AIR: ESCAPE TO THE CRYSTAL PALACE TODAY","NETWATCH ALERT: ROGUE AI DETECTED IN SUB-NET 7","VOODOO BOYS TAGS FOUND IN PACIFICA DATA FORTRESS","MAELSTROM RITUAL DISTURBS NORTHSIDE RESIDENTS","TYGER CLAWS SPOTTED NEAR KABUKI MARKET","6TH STREET PATROLS INCREASE IN SANTO DOMINGO","VALENTINOS HOSTING LOWRIDER PARADE IN HEYWOOD","ANIMALS GANG TAKING OVER GIM IN PACIFICA","SCAVENGERS HARVESTING IMPLANTS: WATCH YOUR BACK","WRAITHS RAIDING CONVOYS IN THE BADLANDS","ALDECALDOS SEEKING SMUGGLING CONTRACTS","MOXES DECLARE LIZZIE'S BAR A SAFE ZONE","FIXER ALERT: REGINA JONES LOOKING FOR MERCS","WAKAKO OKADA: DISCRETION GUARANTEED","DAKOTA SMITH: BADLANDS JOBS AVAILABLE","EL CAPITAN: RIDES FOR SALE, NO QUESTIONS ASKED","MR. HANDS: PACIFICA GIGS, HIGH RISK HIGH REWARD","DINO DINOVIC: CITY CENTER CONTRACTS OPEN","PADRE: HEYWOOD NEEDS CLEANING UP","ROGUE AMENDIARES: THE QUEEN OF THE AFTERLIFE","AFTERLIFE DRINKS: TRY THE JOHNNY SILVERHAND","CLOUDS: FULFILL YOUR FANTASIES, FOR A PRICE","JIG-JIG STREET: ANYTHING YOU WANT, WE HAVE IT","TOTENTANZ: DANCE UNTIL YOU DROP, LITERALLY","EMBERS: EXCLUSIVE DINING FOR THE ELITE","KONPEKI PLAZA: LUXURY HOTELS FOR CORPORATE ROYALTY","NO-TELL MOTEL: WE DON'T ASK, YOU DON'T TELL","DICKY TWISTER: NIGHT CITY'S PREMIER CLUB","RIOT CLUB: ELECTRONIC BEATS AND NEON LIGHTS","7TH HELL: MERCENARY HANGOUT, WATCH YOUR STEP","COYOTE COJO: HEYWOOD'S FAVORITE WATERING HOLE","RED DIRT BAR: LIVE MUSIC AND CHEAP BOOZE","SPACEPORT LAUNCH SCHEDULE DELAYED DUE TO WEATHER","AV CRASH IN CORPO PLAZA: TRAFFIC DIVERTED","COMBAT CAB: ARMORED TRANSPORT FOR THE PARANOID","DELAMAIN AI GLITCH: REFUNDS PROCESSING SLOWLY","NCART DELAYS: TRACK MAINTENANCE IN JAPANTOWN","METRO SYSTEM OVERCROWDED: WATCH FOR PICKPOCKETS","HIGHWAY 101 BLOCKED BY GANG SHOOTOUT","BADLANDS DUST STORM WARNING: VISIBILITY ZERO","TOXIC SPILL IN WATSON: EVACUATION ORDERED","POWER OUTAGE IN SANTO DOMINGO: RIPPERDOCS OFFLINE","NETRUNNER FRYING BRAINS IN KABUKI: STAY OFFLINE","BLACKWALL BREACH RUMORS: NETWATCH DENIES ALL","RELIC PROTOTYPE STOLEN: ARASAKA LOCKDOWN","SOULKILLER MYTH: CONSPIRACY OR REALITY?","ALT CUNNINGHAM: GHOST IN THE MACHINE?","ADAM SMASHER: THE BOOGEYMAN OF NIGHT CITY","MORGAN BLACKHAND: MISSING OR DEAD?","SABURO ARASAKA: EMPEROR OF THE CORPORATE WORLD","YORINOBU ARASAKA: REBELLIOUS SON OR NEW LEADER?","HANAKO ARASAKA: THE PORCELAIN PRINCESS","TAKEMURA: LOYALTY ABOVE ALL ELSE","JUDY ALVAREZ: BD WIZARD OF LIZZIE'S BAR","PANAM PALMER: NOMAD QUEEN OF THE BADLANDS","RIVER WARD: NCPD DETECTIVE ON THE EDGE","KERRY EURODYNE: ROCKERBOY LEGEND RETURNS","US CRACKS: LASERPOP SENSATION TOUR DATES","LIZZY WIZZY: CHROME POP STAR SCANDAL","PERALEZ CAMPAIGN: DREAMING OF A BETTER CITY","MAYOR RHYNE: PUPPET OR POLITICIAN?","HOLT ADMINISTRATION: CORPORATE INTERESTS FIRST","NIGHT CORP: SHADOWY MOVES IN THE DARK","DATA TERM HACKED: FREE EDDIES FOR EVERYONE (FAKE)","SMART LINK FIRMWARE UPDATE: BUG FIXES INCLUDED","MANTIS BLADES RECALL: MALFUNCTIONING ROTORS","GORILLA ARMS: FEEL THE POWER, BREAK THE BONES","MONOWIRE: SLICE THROUGH ANYTHING, SILENTLY","PROJECTILE LAUNCH SYSTEM: EXPLOSIVE SURPRISE","SANDEVISTAN: MOVE FASTER THAN THE EYE CAN SEE","BERSERK OS: UNLEASH YOUR INNER BEAST","CYBERDECK UPGRADES: MORE RAM, MORE HACKS","QUICKHACKS ON SALE: SHORT CIRCUIT YOUR ENEMIES","BREACH PROTOCOL: CRACK THE CODE, STEAL THE DATA","PING: KNOW YOUR SURROUNDINGS, SPOT THE THREATS","CONTAGION: SPREAD THE VIRUS, WATCH THEM FALL","OVERHEAT: BURN THEM FROM THE INSIDE OUT","SYNAPSE BURNOUT: FRY THEIR NEURAL NETWORK","SYSTEM RESET: NON-LETHAL TAKEDOWN GUARANTEED","SUICIDE HACK: MAKE THEM DO THE DIRTY WORK","CYBERPSYCHOSIS HACK: TURN THEM AGAINST EACH OTHER","DETONATE GRENADE: EXPLOSIVE FINALE FOR EVERYONE","REMEMBER: NO FUTURE, BUT WE SURVIVE TODAY",...[`${t} REPUTATION SPREADING`,`${t} TURF SECURE`,`${t} ON THE RISE`,`STREET CRED: ${t} RESPECTED`,`${t} MAKING MOVES`,`RIVALS FEAR ${t}`,`${t} OWNS THE NIGHT`]],s=n[Math.floor(Math.random()*n.length)];e.textContent=s,e.classList.add("glitch-text"),e.style.opacity="1",setTimeout(()=>{e.classList.remove("glitch-text")},500)},500)};t(),setInterval(t,8e3)}setupListeners(){window.addEventListener("building-click",e=>{const t=e.detail.type;"hideout"===t?this.openMissionBoard():"bar"===t?this.openAfterlife():"ripperdoc"===t&&this.openRipperdoc()}),window.addEventListener("mission-complete",e=>{const t=e.detail;this.showMissionReward(t)});const e=()=>{H.startBackgroundMusic(),document.removeEventListener("click",e)};document.addEventListener("click",e),window.addEventListener("show-gang-name-modal",()=>{this.showGangNameModal()}),window.addEventListener("open-territory-details",e=>{const t=e.detail;this.openTerritoryModal(t.territoryId)})}setupStoreSubscription(){c.subscribe(e=>{const t=document.getElementById("hud-eddies"),n=document.getElementById("hud-rep"),s=document.getElementById("hud-members");if(t){const n=parseInt(t.textContent?.replace(/,/g,"")||"0");if(e.eddies!==n&&0!==n){const s=e.eddies-n,i=t.getBoundingClientRect();this.showFloatingText(`${s>0?"+":""}${s}€`,i.left,i.bottom+5,s>0?"text-cp-yellow":"text-cp-red")}t.textContent=e.eddies.toLocaleString(),t.parentElement?.classList.remove("animate-pulse-cyber"),t.offsetWidth,t.parentElement?.classList.add("animate-pulse-cyber")}if(n){const t=parseInt(n.textContent?.replace(/,/g,"")||"0");if(e.rep!==t&&0!==t){const s=e.rep-t,i=n.getBoundingClientRect();this.showFloatingText(`${s>0?"+":""}${s} REP`,i.left,i.bottom+5,s>0?"text-cp-cyan":"text-cp-red")}n.textContent=e.rep.toLocaleString()}s&&(s.textContent=e.members.length.toString());const i=document.getElementById("gang-name-header");i&&(i.textContent=e.gangName.toUpperCase());const a=document.getElementById("mission-tab-content");a&&("missions"===this.activeTab?e.activeMissions===this.lastActiveMissions&&e.availableMissions===this.lastAvailableMissions||(this.lastActiveMissions=e.activeMissions,this.lastAvailableMissions=e.availableMissions,this.renderMissionsTab(a)):"roster"===this.activeTab&&this.renderRosterTab(a));const o=document.getElementById("afterlife-tab-content");o&&e.territories!==this.lastTerritories&&(this.lastTerritories=e.territories,"territory"===this.activeTab&&this.renderTerritoryTab(o),"gangs"===this.activeTab&&this.renderGangsTab(o));const r=document.getElementById("ripperdoc-tab-content");if(r&&"medical"===this.activeTab){const e=r.closest(".fixed");e&&this.renderMedicalTab(r,e)}this.renderEncounters(e.activeEncounters)})}renderEncounters(e){document.querySelectorAll(".encounter-marker").forEach(t=>{e.find(e=>e.id===t.dataset.id)||t.remove()}),e.forEach(e=>{if(!document.querySelector(`.encounter-marker[data-id="${e.id}"]`)){H.playAlert();const t=document.createElement("div");t.className="encounter-marker absolute w-16 h-16 flex items-center justify-center cursor-pointer z-[60] pointer-events-auto group",t.style.left=`${e.x}%`,t.style.top=`${e.y}%`,t.dataset.id=e.id,t.innerHTML='\n                <div class="absolute inset-0 bg-cp-yellow/30 rounded-full animate-ping"></div>\n                <div class="absolute inset-0 bg-cp-red/20 rotate-45 border-2 border-cp-yellow shadow-[0_0_15px_var(--cp-yellow)] transition-transform group-hover:scale-110 bg-black/80"></div>\n                <div class="relative text-cp-yellow text-4xl font-bold drop-shadow-[0_0_5px_var(--cp-red)] animate-pulse">!</div>\n                <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-black/90 border border-cp-yellow text-cp-yellow text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 font-cyber tracking-wider">\n                    SIGNAL DETECTED\n                </div>\n            ',t.addEventListener("click",t=>{t.stopPropagation(),H.playClick(),this.openEncounterModal(e.id,e.encounterId)}),this.container.appendChild(t)}})}openEncounterModal(e,t){const n=L.find(e=>e.id===t);if(!n)return;const s=this.createOverlay(),i=document.createElement("div");i.className="bg-cp-bg border-[3px] border-cp-red shadow-[0_0_40px_rgba(255,0,0,0.5)] w-[90%] max-w-[600px] flex flex-col animate-modalSlideIn pointer-events-auto relative",i.innerHTML=`\n        <div class="bg-cp-red/20 border-b-2 border-cp-red p-5 flex justify-between items-center shrink-0">\n            <h2 class="text-cp-red m-0 text-2xl drop-shadow-[0_0_10px_var(--cp-red)] font-cyber font-bold uppercase">${n.title}</h2>\n            <button id="close-encounter" class="bg-transparent border-2 border-cp-red text-cp-red text-2xl w-8 h-8 cursor-pointer transition-all duration-300 hover:bg-cp-red hover:text-white hover:rotate-90 flex items-center justify-center font-bold">&times;</button>\n        </div>\n        \n        <div class="p-6">\n            <p class="text-white text-lg mb-6 font-cyber leading-relaxed border-l-4 border-cp-yellow pl-4 bg-black/30 p-4">\n                "${n.description}"\n            </p>\n\n            <div class="space-y-3">\n                ${n.options.map((e,t)=>{let n="";if(e.skillCheck){const t=c.get().members.find(e=>1===e.id),s=(t?t.stats:{cool:0,reflex:0})["tech"===e.skillCheck.stat?"cool":e.skillCheck.stat]||0,i=e.skillCheck.difficulty+5-s,a=10*Math.max(0,Math.min(10,11-i));let o="text-cp-red";a>=70?o="text-green-500":a>=40&&(o="text-yellow-500");n=`<div class="text-xs mt-1 font-mono">\n                            <span class="text-gray-400">V'S ${"tech"===e.skillCheck.stat?"COOL (TECH)":e.skillCheck.stat.toUpperCase()} CHECK:</span> \n                            <span class="${o} font-bold">${a}% CHANCE</span>\n                        </div>`}return`\n                    <button class="encounter-opt-btn w-full text-left p-4 border-2 border-gray-600 hover:border-cp-yellow hover:bg-cp-yellow/10 transition-all group relative overflow-hidden" data-index="${t}">\n                        <div class="font-bold text-cp-yellow text-lg group-hover:translate-x-2 transition-transform">${e.text}</div>\n                        ${n}\n                    </button>\n                `}).join("")}\n            </div>\n        </div>\n      `,s.appendChild(i),this.modalContainer.appendChild(s),i.querySelector("#close-encounter")?.addEventListener("click",()=>s.remove()),i.querySelectorAll(".encounter-opt-btn").forEach(n=>{n.addEventListener("click",n=>{const i=parseInt(n.currentTarget.dataset.index),a=k.resolveEncounter(t,i);x(e),s.remove(),this.showEncounterResult(a.message,a.success,a.effects)})})}showEncounterResult(e,t,n){const s=this.createOverlay(),i=document.createElement("div"),a=t?"cp-cyan":"cp-red";i.className=`bg-cp-bg border-[3px] border-${a} shadow-[0_0_40px_rgba(${t?"0,240,255":"255,0,0"},0.5)] w-[90%] max-w-[600px] flex flex-col animate-modalSlideIn pointer-events-auto`;let o="";if(n){const e=[];if(n.cost&&e.push(`<div class="flex items-center gap-2 text-cp-red"><span class="text-2xl">💸</span> <span>-${n.cost}€ COST</span></div>`),n.rewards&&(n.rewards.eddies&&e.push(`<div class="flex items-center gap-2 text-cp-yellow"><span class="text-2xl">💰</span> <span>+${n.rewards.eddies}€ EDDIES</span></div>`),n.rewards.xp&&e.push(`<div class="flex items-center gap-2 text-cp-cyan"><span class="text-2xl">⭐</span> <span>+${n.rewards.xp} XP</span></div>`),n.rewards.rep&&e.push(`<div class="flex items-center gap-2 text-green-400"><span class="text-2xl">🏆</span> <span>+${n.rewards.rep} REP</span></div>`),n.rewards.health)){const t=n.rewards.targetName?` (${n.rewards.targetName})`:"";e.push(`<div class="flex items-center gap-2 text-green-500"><span class="text-2xl">❤️</span> <span>+${n.rewards.health} HP${t}</span></div>`)}if(n.penalties&&(n.penalties.eddies&&e.push(`<div class="flex items-center gap-2 text-orange-500"><span class="text-2xl">💸</span> <span>-${n.penalties.eddies}€ LOST</span></div>`),n.penalties.rep&&e.push(`<div class="flex items-center gap-2 text-orange-500"><span class="text-2xl">📉</span> <span>-${Math.abs(n.penalties.rep)} REP</span></div>`),n.penalties.health)){const t=n.penalties.targetName?` (${n.penalties.targetName})`:"";e.push(`<div class="flex items-center gap-2 text-cp-red"><span class="text-2xl">💔</span> <span>-${n.penalties.health} HP DAMAGE${t}</span></div>`)}e.length>0&&(o=`\n          <div class="bg-black/40 border-t-2 border-${a}/30 p-4 mt-4">\n            <h3 class="text-cp-yellow font-bold font-cyber text-sm mb-3 uppercase tracking-wider">Effects Applied:</h3>\n            <div class="space-y-2 text-base font-cyber">\n              ${e.join("")}\n            </div>\n          </div>\n        `)}i.innerHTML=`\n        <div class="bg-${a}/10 border-b-2 border-${a} p-5">\n          <h2 class="text-${a} text-3xl font-bold font-cyber text-center drop-shadow-[0_0_10px_var(--${a})]">\n            ${t?"✓ SUCCESS":"✗ FAILURE"}\n          </h2>\n        </div>\n        <div class="p-6">\n          <p class="text-white text-lg mb-4 font-cyber leading-relaxed border-l-4 border-${a} pl-4 bg-black/30 p-4">"${e}"</p>\n          ${o}\n        </div>\n        <div class="border-t-2 border-${a} p-5">\n          <button id="close-result" class="cyber-btn w-full py-3 text-xl">CLOSE</button>\n        </div>\n      `,s.appendChild(i),this.modalContainer.appendChild(s),i.querySelector("#close-result")?.addEventListener("click",()=>{H.playClick(),s.remove()})}createOverlay(){const e=document.createElement("div");e.className="fixed inset-0 bg-black/95 flex justify-center items-center z-[10001] animate-[fadeIn_0.3s] pointer-events-auto";const t=e=>e.stopPropagation();return e.addEventListener("pointerdown",t),e.addEventListener("mousedown",t),e.addEventListener("touchstart",t),e.addEventListener("click",t),e}openMissionBoard(){this.modalContainer.innerHTML="";const e=this.createOverlay();e.addEventListener("click",t=>{t.target===e&&e.remove()});const t=document.createElement("div");t.className="bg-cp-bg border-[3px] border-cp-cyan shadow-[0_0_40px_rgba(0,240,255,0.5)] w-[90%] max-w-[1000px] h-[85vh] flex flex-col animate-modalSlideIn pointer-events-auto",t.innerHTML=`\n      <div class="bg-cp-cyan/10 border-b-2 border-cp-cyan p-5 flex justify-between items-center shrink-0">\n        <h2 id="hideout-title" class="text-cp-cyan m-0 text-3xl drop-shadow-[0_0_10px_var(--cp-cyan)] font-cyber font-bold">${c.get().gangName}'s HIDEOUT</h2>\n        <button id="close-modal" class="bg-transparent border-2 border-cp-red text-cp-red text-3xl w-10 h-10 cursor-pointer transition-all duration-300 hover:bg-cp-red hover:text-white hover:rotate-90 flex items-center justify-center font-bold">&times;</button>\n      </div>\n      \n      \x3c!-- Tabs --\x3e\n      <div class="flex gap-2 p-4 bg-black/30 border-b border-cp-yellow/30">\n        <button class="cyber-btn tab-btn active" data-tab="missions">MISSIONS</button>\n        <button class="cyber-btn tab-btn" data-tab="roster">ROSTER</button>\n      </div>\n\n      \x3c!-- Tab Content --\x3e\n      <div class="flex-1 overflow-y-auto p-5" id="mission-tab-content"></div>\n    `,e.appendChild(t),this.modalContainer.appendChild(e);const n=t.querySelector("#mission-tab-content");this.activeTab="missions",t.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{t.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.activeTab=e.dataset.tab,H.playClick(),"missions"===this.activeTab?this.renderMissionsTab(n):"roster"===this.activeTab&&this.renderRosterTab(n)})}),t.querySelector("#close-modal")?.addEventListener("click",()=>e.remove()),this.renderMissionsTab(n)}renderMissionsTab(e){const t=c.get();if(e.innerHTML="",t.activeMissions.length>0){const n=document.createElement("h3");n.className="text-cp-cyan font-cyber text-xl mb-3 mt-2",n.textContent="ACTIVE MISSIONS",e.appendChild(n),t.activeMissions.forEach(n=>{const s=t.members.filter(e=>n.memberIds.includes(e.id));if(0===s.length)return;const i=n.mission,a=n.startTime,o=i.duration,r=document.createElement("div");r.className="bg-black/60 border-2 border-cp-cyan p-4 mb-3 animate-pulse";const l=s.length>1?`TEAM (${s.length})`:s[0].name;r.innerHTML=`\n          <div class="flex justify-between items-start mb-2">\n            <div>\n              <div class="font-bold text-white font-cyber text-lg">${i.name}</div>\n              <div class="text-cp-cyan text-sm font-cyber">[${i.type}]</div>\n            </div>\n            <div class="text-right">\n              <div class="text-cp-yellow font-bold font-cyber">${l}</div>\n              <div class="text-gray-400 text-xs truncate max-w-[150px]">\n                ${s.map(e=>`<span class="text-[10px] bg-cp-cyan/20 px-1 mr-1">${e.class.substring(0,3)}</span>${e.name}`).join(", ")}\n              </div>\n            </div>\n          </div>\n          \n          <div class="w-full h-4 bg-gray-800 border border-cp-cyan mt-2 relative overflow-hidden">\n            <div class="h-full bg-cp-cyan transition-all duration-1000 ease-linear mission-progress" style="width: 0%" id="progress-${n.id}"></div>\n          </div>\n          <div class="text-right text-cp-cyan font-mono text-sm mt-1 mission-timer" id="timer-${n.id}">CALCULATING...</div>\n        `,e.appendChild(r);const c=()=>{if(!document.body.contains(r))return;const e=Date.now()-a,t=Math.max(0,o-e),n=Math.min(100,e/o*100),s=r.querySelector(".mission-progress"),i=r.querySelector(".mission-timer");s&&(s.style.width=`${n}%`),i&&(i.textContent=`${(t/1e3).toFixed(1)}s remaining`),t>0?requestAnimationFrame(c):(i&&(i.textContent="COMPLETED"),r.classList.remove("animate-pulse"),r.classList.add("border-green-500"))};requestAnimationFrame(c)});const s=document.createElement("hr");s.className="border-gray-700 my-6",e.appendChild(s)}const n=document.createElement("div");n.className="flex justify-between items-center mb-4",n.innerHTML='<h3 class="text-cp-yellow font-cyber text-xl">AVAILABLE MISSIONS</h3>';const s=document.createElement("button");s.className="cyber-btn small-btn text-xs px-3 py-1",s.textContent="REFRESH (50€)",s.addEventListener("click",()=>{H.playClick(),c.get().eddies>=50&&(d(-50),m(),1)?(this.showToast("MISSIONS REFRESHED","success"),this.renderMissionsTab(e)):this.showToast("INSUFFICIENT FUNDS","error")}),n.appendChild(s),e.appendChild(n),0!==t.availableMissions.length?t.availableMissions.forEach(t=>{const n=document.createElement("div");n.className="bg-black/60 border-2 border-cp-yellow p-4 mb-3 cursor-pointer transition-all duration-300 hover:border-cp-cyan hover:translate-x-2 hover:shadow-[0_0_25px_rgba(0,240,255,0.4)] hover:bg-cp-cyan/5 animate-slideIn opacity-0 fill-mode-forwards";const s={EASY:"text-green-400",MEDIUM:"text-yellow-400",HARD:"text-orange-400",EXTREME:"text-cp-red"}[t.difficulty];n.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n          <h3 class="font-bold text-white font-cyber text-lg">${t.name}</h3>\n          <span class="text-xs font-bold ${s} border border-current px-2 py-1">${t.difficulty}</span>\n        </div>\n        <div class="text-cp-yellow text-sm mb-2 font-cyber">${t.type}</div>\n        <p class="text-gray-400 text-xs mb-3 h-10 overflow-hidden font-cyber">${t.description}</p>\n        <div class="flex gap-5 text-sm text-gray-400 font-cyber">\n          <span class="group-hover:text-cp-cyan transition-colors">💰 ${t.eddiesMin}-${t.eddiesMax}€</span>\n          <span class="group-hover:text-cp-cyan transition-colors">⭐ ${t.xpMin}-${t.xpMax} XP</span>\n          <span class="group-hover:text-cp-cyan transition-colors">⏱ ${t.duration/1e3}s</span>\n        </div>\n      `,n.addEventListener("click",()=>{H.playPanelOpen(),this.openMissionDetail(t)}),e.appendChild(n)}):e.innerHTML+='<div class="text-center text-gray-500 font-cyber py-8 text-xl">NO MISSIONS AVAILABLE</div>'}openMissionDetail(e){const t=this.createOverlay();t.addEventListener("click",e=>{e.target===t&&t.remove()});const n=document.createElement("div");n.className="bg-cp-bg border-[3px] border-cp-cyan shadow-[0_0_40px_rgba(0,240,255,0.5)] w-[95%] max-w-[1100px] h-[90vh] flex flex-col animate-modalSlideIn pointer-events-auto",n.innerHTML=`\n      <div class="bg-cp-cyan/10 border-b-2 border-cp-cyan p-4 flex justify-between items-center shrink-0">\n        <h2 class="text-cp-cyan m-0 text-2xl drop-shadow-[0_0_10px_var(--cp-cyan)] font-cyber font-bold uppercase">${e.name}</h2>\n        <button id="close-detail" class="bg-transparent border-2 border-cp-red text-cp-red text-2xl w-8 h-8 cursor-pointer transition-all duration-300 hover:bg-cp-red hover:text-white hover:rotate-90 flex items-center justify-center font-bold">&times;</button>\n      </div>\n      \n      <div class="flex flex-col md:flex-row gap-4 p-4 overflow-hidden flex-1">\n        \x3c!-- Left Column: Details & Stats --\x3e\n        <div class="flex-1 flex flex-col gap-3 overflow-y-auto pr-2 min-w-0">\n          <div class="shrink-0">\n            <div class="flex justify-between items-center mb-2">\n              <span class="inline-block px-2 py-1 text-sm font-bold rounded bg-cp-black border border-cp-yellow text-cp-yellow">\n                ${e.difficulty}\n              </span>\n              <div class="text-cp-yellow text-sm font-cyber">${e.type}</div>\n            </div>\n            \n            <div class="text-white text-sm leading-snug mb-3 p-3 bg-black/30 border-l-[3px] border-cp-yellow italic font-cyber">\n              "${e.description}"\n            </div>\n          </div>\n\n          \x3c!-- Mission Stats Grid --\x3e\n          <div class="grid grid-cols-2 gap-2 shrink-0">\n            <div class="bg-cp-cyan/5 border border-cp-cyan/30 p-2 flex flex-col justify-center items-center gap-1">\n              <div class="text-cp-cyan text-[10px] font-bold tracking-wider">REWARD</div>\n              <div class="text-white text-base font-cyber font-bold text-shadow-neon">${e.eddiesMin}-${e.eddiesMax}€</div>\n            </div>\n            <div class="bg-cp-cyan/5 border border-cp-cyan/30 p-2 flex flex-col justify-center items-center gap-1">\n              <div class="text-cp-cyan text-[10px] font-bold tracking-wider">XP</div>\n              <div class="text-white text-base font-cyber font-bold text-shadow-neon">${e.xpMin}-${e.xpMax}</div>\n            </div>\n            <div class="bg-cp-cyan/5 border border-cp-cyan/30 p-2 flex flex-col justify-center items-center gap-1">\n              <div class="text-cp-cyan text-[10px] font-bold tracking-wider">TIME</div>\n              <div class="text-white text-base font-cyber font-bold text-shadow-neon">${e.duration/1e3}s</div>\n            </div>\n            <div class="bg-cp-cyan/5 border border-cp-cyan/30 p-2 flex flex-col justify-center items-center gap-1">\n              <div class="text-cp-cyan text-[10px] font-bold tracking-wider">RISK</div>\n              <div class="text-white text-base font-cyber font-bold text-shadow-neon">${Math.round(100*e.injuryChance)}%</div>\n            </div>\n          </div>\n\n          \x3c!-- Prediction Stats --\x3e\n          <div class="bg-black/40 border border-gray-700 p-3 mt-1 shrink-0">\n             <div class="flex justify-between items-center mb-1">\n                <span class="text-gray-400 text-xs">TEAM POWER</span>\n                <span id="team-power" class="text-cp-cyan font-bold">0</span>\n             </div>\n             <div class="flex justify-between items-center mb-1">\n                <span class="text-gray-400 text-xs">WIN CHANCE</span>\n                <span id="win-chance" class="text-white font-bold">0%</span>\n             </div>\n             <div class="w-full h-2 bg-gray-800 mt-1 mb-2">\n                <div id="win-bar" class="h-full bg-cp-cyan transition-all duration-300" style="width: 0%"></div>\n             </div>\n             <div class="flex justify-between items-center">\n                <span class="text-gray-400 text-xs">INJURY RISK</span>\n                <span id="injury-risk" class="text-cp-red font-bold">--</span>\n             </div>\n          </div>\n          \n          <div id="active-passives" class="flex flex-col gap-1 mt-1 text-xs"></div>\n        </div>\n\n        \x3c!-- Right Column: Crew Selection --\x3e\n        <div class="flex-1 flex flex-col h-full overflow-hidden md:border-l md:border-cp-cyan/30 md:pl-4 min-w-0">\n          <div class="flex justify-between items-center mb-2 shrink-0">\n            <h3 class="text-cp-yellow m-0 font-cyber text-base font-bold">SELECT CREW</h3>\n            <span class="text-xs text-gray-400 bg-black/50 px-2 py-1 rounded border border-gray-700">MAX 3</span>\n          </div>\n          \n          <div id="crew-list" class="flex-1 overflow-y-auto space-y-2 pr-1 scrollbar-thin">\n            \x3c!-- Crew members go here --\x3e\n          </div>\n        </div>\n      </div>\n\n      <div class="border-t-2 border-cp-cyan p-4 flex justify-between items-center bg-black/30 shrink-0 relative overflow-hidden">\n        <div class="text-cp-yellow text-lg font-bold font-cyber z-10">\n          SELECTED: <span id="selected-count">0</span>/3\n        </div>\n        \n        \x3c!-- Biker Animation (Hidden by default) --\x3e\n        <div id="mission-biker" class="absolute left-0 bottom-0 h-full w-[120px] pointer-events-none opacity-0 z-0 transform -translate-x-full">\n           <img src="assets/biker.png" class="w-full h-full object-contain drop-shadow-[0_0_5px_var(--cp-cyan)]" />\n        </div>\n\n        <button id="send-crew-btn" class="cyber-btn px-4 py-2 text-base md:px-8 md:py-3 md:text-lg disabled:opacity-50 disabled:cursor-not-allowed z-10">\n          SEND CREW\n        </button>\n      </div>\n    `,t.appendChild(n),this.modalContainer.appendChild(t);let s=[];const i=n.querySelector("#send-crew-btn"),a=n.querySelector("#selected-count"),o=n.querySelector("#mission-biker"),l=n.querySelector("#team-power"),d=n.querySelector("#win-chance"),p=n.querySelector("#win-bar"),h=n.querySelector("#injury-risk");i.disabled=!0;const m=n.querySelector("#crew-list"),x=c.get().members.filter(e=>"IDLE"===e.status&&!e.injured);0===x.length?m.innerHTML='<div class="text-cp-red text-center p-5 font-cyber text-sm">NO AVAILABLE MEMBERS</div>':x.forEach(t=>{const o=document.createElement("div");o.className="flex items-center gap-3 p-2 bg-black/40 border border-[#555] cursor-pointer transition-all duration-300 hover:bg-cp-cyan/10 hover:translate-x-1 hover:shadow-[0_0_15px_rgba(0,240,255,0.3)]";const u=t.level>=e.minLevel,g=!e.minCool||t.stats.cool>=e.minCool,y=!e.minReflex||t.stats.reflex>=e.minReflex,x=u&&g&&y;x?o.classList.add("border-cp-cyan"):o.classList.add("opacity-50","cursor-not-allowed","border-red-900"),o.innerHTML=`\n          <div class="flex-1 min-w-0">\n            <div class="flex justify-between items-center mb-1">\n              <div class="font-bold text-white font-cyber text-sm truncate">${t.name}</div>\n              <div class="text-[10px] text-cp-yellow font-cyber whitespace-nowrap">LVL ${t.level}</div>\n            </div>\n            <div class="flex gap-2 text-[10px] text-gray-400 font-mono">\n              <span>COOL: <span class="${t.stats.cool>=(e.minCool||0)?"text-cp-cyan":"text-red-500"}">${t.stats.cool}</span></span>\n              <span>REF: <span class="${t.stats.reflex>=(e.minReflex||0)?"text-cp-cyan":"text-red-500"}">${t.stats.reflex}</span></span>\n            </div>\n          </div>\n          <div class="w-5 h-5 border border-cp-cyan flex items-center justify-center text-xs check-box transition-all shrink-0"></div>\n        `,x&&o.addEventListener("click",()=>{H.playClick();const u=s.indexOf(t.id),m=o.querySelector(".check-box");if(u>-1)s.splice(u,1),o.classList.remove("bg-cp-cyan/20","border-cp-yellow","shadow-[0_0_20px_rgba(252,238,10,0.4)]"),m.classList.remove("bg-cp-yellow","border-cp-yellow"),m.textContent="";else{if(s.length>=3)return void this.showToast("MAX 3 MEMBERS","warning");s.push(t.id),o.classList.add("bg-cp-cyan/20","border-cp-yellow","shadow-[0_0_20px_rgba(252,238,10,0.4)]"),m.classList.add("bg-cp-yellow","border-cp-yellow"),m.textContent="✓"}a.textContent=s.length.toString(),i.disabled=0===s.length,(()=>{const t=c.get().members.filter(e=>s.includes(e.id));if(0===t.length){l.textContent="0",d.textContent="0%",p.style.width="0%",h.textContent="--";const e=n.querySelector("#active-passives");return void(e&&(e.innerHTML=""))}const i=t.reduce((e,t)=>e+2*(t.stats.cool+t.stats.reflex)+5*t.level,0),a=e.difficultyRating||50,o=Math.min(.95,Math.max(.05,i/a)),u=.05*(t.length-1);let m=Math.max(.05,e.injuryChance-u);o>.5&&(m*=.5),l.textContent=i.toString(),d.textContent=`${Math.round(100*o)}%`,p.style.width=`${Math.round(100*o)}%`,d.className=o>.8?"text-green-500 font-bold":o>.5?"text-yellow-500 font-bold":"text-red-500 font-bold",h.textContent=`${Math.round(100*m)}%`;const g=t.map(e=>{const t=r[e.class];return`<div class="text-[10px] text-cp-cyan truncate">• ${e.name}: ${t.passive}</div>`}).join(""),y=n.querySelector("#active-passives");y&&(y.innerHTML=g)})()}),m.appendChild(o)}),n.querySelector("#close-detail")?.addEventListener("click",()=>t.remove()),i.addEventListener("click",()=>{H.playClick(),s.length>0&&(i.disabled=!0,i.textContent="SENDING...",o.style.opacity="1",o.animate([{transform:"translateX(-100%)"},{transform:"translateX(1000px)"}],{duration:1500,easing:"ease-in"}),setTimeout(()=>{const n=((e,t,n=null)=>{const s=c.get(),i=s.availableMissions.find(e=>e.id===t);if(!i)return{success:!1,reason:"Mission not found"};if(0===e.length)return{success:!1,reason:"No members selected"};const a=s.members.filter(t=>e.includes(t.id));for(const c of a){if("IDLE"!==c.status)return{success:!1,reason:`${c.name} is busy`};if(c.injured)return{success:!1,reason:`${c.name} is injured`};if(c.level<i.minLevel)return{success:!1,reason:`${c.name} level too low`};if(i.minCool&&c.stats.cool<i.minCool)return{success:!1,reason:`${c.name} Cool too low`};if(i.minReflex&&c.stats.reflex<i.minReflex)return{success:!1,reason:`${c.name} Reflex too low`}}const o=s.members.map(t=>e.includes(t.id)?{...t,status:"ON MISSION",currentMission:i.name}:t);c.setKey("members",o);let r=null!==n?n:i.duration;const l=s.upgrades.find(e=>"GARAGE"===e.id);let d=1-(l?.1*l.level:0);a.some(e=>"NOMAD"===e.class)&&(d-=.15),r=Math.floor(r*Math.max(.1,d));const p={id:Date.now()+Math.floor(1e3*Math.random()),memberIds:e,mission:i,startTime:Date.now(),endTime:Date.now()+r},h=[...s.activeMissions,p];return c.setKey("activeMissions",h),y(t),g(),setTimeout(()=>{u(p.id)},r),{success:!0}})(s,e.id);n.success?(H.playPurchase(),this.showToast("MISSION STARTED","success"),i.textContent="SENT!",setTimeout(()=>t.remove(),800)):(this.showToast(n.reason||"FAILED","error"),i.disabled=!1,i.textContent="SEND CREW",o.style.opacity="0")},1e3))})}showMissionReward(e){const{rewards:t,leveledUp:n,injured:s}=e,i=c.get().gangName.toUpperCase();s?(H.playInjury(),this.showToast(`${i} MISSION FAILED - AGENT INJURED`,"error")):(H.playMissionComplete(),this.showToast(`${i} MISSION COMPLETE (+${t.eddies}€)`,"success"),n&&(H.playLevelUp(),setTimeout(()=>this.showToast(`${i} MEMBER LEVELED UP!`,"success"),500)))}showToast(e,t){const n=document.createElement("div");n.className=`fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 ${{success:"bg-green-500",warning:"bg-yellow-500",error:"bg-red-500"}[t]} text-black font-bold font-cyber z-[20000] animate-bounce shadow-[0_0_10px_currentColor]`,n.textContent=e,this.container.appendChild(n),setTimeout(()=>n.remove(),3e3)}async openAfterlife(){const e=this.createOverlay();e.addEventListener("click",t=>{t.target===e&&e.remove()});const t=document.createElement("div");t.className="bg-cp-bg border-[3px] border-cp-cyan shadow-[0_0_40px_rgba(0,240,255,0.5)] w-[90%] max-w-[1000px] h-[85vh] flex flex-col animate-modalSlideIn pointer-events-auto relative",t.innerHTML='\n      <div class="bg-cp-cyan/10 border-b-2 border-cp-cyan p-5 flex justify-between items-center shrink-0">\n        <h2 class="text-cp-cyan m-0 text-3xl drop-shadow-[0_0_10px_var(--cp-cyan)] font-cyber font-bold">AFTERLIFE</h2>\n        <button id="close-modal" class="bg-transparent border-2 border-cp-red text-cp-red text-3xl w-10 h-10 cursor-pointer transition-all duration-300 hover:bg-cp-red hover:text-white hover:rotate-90 flex items-center justify-center font-bold">&times;</button>\n      </div>\n\n      \x3c!-- Tabs --\x3e\n      <div class="flex gap-2 p-4 bg-black/30 border-b border-cp-yellow/30">\n        <button class="cyber-btn tab-btn active" data-tab="territory">TERRITORY</button>\n        <button class="cyber-btn tab-btn" data-tab="gangs">GANGS</button>\n      </div>\n\n      <div class="flex-1 overflow-y-auto p-5" id="afterlife-tab-content"></div>\n    ',e.appendChild(t),this.modalContainer.appendChild(e);const n=t.querySelector("#afterlife-tab-content");this.activeTab="territory",t.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{t.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.activeTab=e.dataset.tab,H.playClick(),"territory"===this.activeTab?this.renderTerritoryTab(n):"gangs"===this.activeTab&&this.renderGangsTab(n)})}),t.querySelector("#close-modal")?.addEventListener("click",()=>e.remove()),this.renderTerritoryTab(n)}openRipperdoc(){const e=this.createOverlay();e.addEventListener("click",t=>{t.target===e&&e.remove()});const t=document.createElement("div");t.className="bg-cp-bg border-[3px] border-cp-cyan shadow-[0_0_40px_rgba(0,240,255,0.5)] w-[90%] max-w-[900px] max-h-[85vh] flex flex-col animate-modalSlideIn pointer-events-auto",t.innerHTML='\n      <div class="bg-cp-cyan/10 border-b-2 border-cp-cyan p-5 flex justify-between items-center shrink-0">\n        <h2 class="text-cp-cyan m-0 text-3xl drop-shadow-[0_0_10px_var(--cp-cyan)] font-cyber font-bold">RIPPERDOC</h2>\n        <button id="close-ripperdoc" class="bg-transparent border-2 border-cp-red text-cp-red text-3xl w-10 h-10 cursor-pointer transition-all duration-300 hover:bg-cp-red hover:text-white hover:rotate-90 flex items-center justify-center font-bold">&times;</button>\n      </div>\n\n      \x3c!-- Tabs --\x3e\n      <div class="flex gap-2 p-4 bg-black/30 border-b border-cp-yellow/30">\n        <button class="cyber-btn tab-btn active" data-tab="medical">MEDICAL</button>\n        <button class="cyber-btn tab-btn" data-tab="recruit">RECRUIT</button>\n      </div>\n\n      <div class="flex-1 overflow-y-auto p-5" id="ripperdoc-tab-content"></div>\n    ',e.appendChild(t),this.modalContainer.appendChild(e);const n=t.querySelector("#ripperdoc-tab-content");this.activeTab="medical",t.querySelectorAll(".tab-btn").forEach(s=>{s.addEventListener("click",()=>{t.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),s.classList.add("active"),this.activeTab=s.dataset.tab,H.playClick(),"medical"===this.activeTab?this.renderMedicalTab(n,e):"recruit"===this.activeTab&&this.renderRecruitTab(n,e)})}),t.querySelector("#close-ripperdoc")?.addEventListener("click",()=>e.remove()),this.renderMedicalTab(n,e)}renderMedicalTab(e,t){e.innerHTML='\n        <h3 class="text-cp-yellow font-cyber mb-4">MEDICAL & UPGRADES</h3>\n        <p class="text-gray-400 mb-4">Heal injured members and install cyberware</p>\n        <div id="members-list"></div>\n    ';const n=e.querySelector("#members-list");c.get().members.forEach(e=>{const t=document.createElement("div");t.className="bg-black/60 border-2 border-cp-cyan p-4 mb-4";const s=e.health/e.maxHealth*100,i=100*e.stats.cool,a=100*e.stats.reflex;t.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n          <div>\n            <div class="text-cp-cyan font-bold text-lg font-cyber leading-none">${e.name} <span class="text-xs text-cp-yellow">LVL ${e.level}</span></div>\n            <div class="text-xs text-gray-400 font-mono mt-1">COOL: <span class="text-white">${e.stats.cool}</span> | REF: <span class="text-white">${e.stats.reflex}</span></div>\n          </div>\n          <div class="text-sm font-bold ${e.injured?"text-cp-red":"text-green-500"}">${e.injured?"INJURED":"HEALTHY"}</div>\n        </div>\n\n        <div class="relative h-6 bg-gray-800 mb-2">\n          <div class="absolute inset-0 bg-green-500" style="width: ${s}%"></div>\n          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${e.health}/${e.maxHealth} HP</div>\n        </div>\n        \n        ${e.injured?`\n          <button class="cyber-btn w-full mt-2" data-heal="${e.id}">HEAL (200€)</button>\n        `:`\n          <div class="mt-3">\n            <h4 class="text-cp-yellow text-sm mb-2 font-cyber">CYBERWARE UPGRADES</h4>\n            <div class="grid grid-cols-3 gap-2">\n              <button class="cyber-btn text-xs" data-upgrade="${e.id}" data-type="cool">+2 COOL (${i}€)</button>\n              <button class="cyber-btn text-xs" data-upgrade="${e.id}" data-type="reflex">+2 REF (${a}€)</button>\n              <button class="cyber-btn text-xs" data-upgrade="${e.id}" data-type="health">+20 HP (500€)</button>\n            </div>\n          </div>\n        `}\n      `,n.appendChild(t)}),n.querySelectorAll("[data-heal]").forEach(n=>{n.addEventListener("click",()=>{H.playClick();(e=>{const t=c.get(),n=t.members.find(t=>t.id===e);if(n&&n.injured){const e=t.upgrades.find(e=>"MEDBAY"===e.id),s=e?.1*e.level:0,i=Math.floor(500*(1-s));if(t.eddies>=i)return d(-i),n.health=n.maxHealth,n.injured=!1,n.status="IDLE",c.setKey("members",[...t.members]),!0}return!1})(parseInt(n.dataset.heal))?(H.playHeal(),this.showToast("MEMBER HEALED","success"),this.renderMedicalTab(e,t)):this.showToast("INSUFFICIENT FUNDS","error")})}),n.querySelectorAll("[data-upgrade]").forEach(n=>{n.addEventListener("click",()=>{H.playClick();const s=parseInt(n.dataset.upgrade),i=n.dataset.type;((e,t)=>{const n=c.get(),s=n.members.find(t=>t.id===e);if(!s)return!1;const i=Math.min(n.rep/400,.25);let a=0,o=!1;switch(t){case"cool":a=Math.floor(100*s.stats.cool*(1-i)),n.eddies>=a&&(d(-a),s.stats.cool+=2,o=!0);break;case"reflex":a=Math.floor(100*s.stats.reflex*(1-i)),n.eddies>=a&&(d(-a),s.stats.reflex+=2,o=!0);break;case"health":a=Math.floor(500*(1-i)),n.eddies>=a&&(d(-a),s.maxHealth+=20,s.health=s.maxHealth,o=!0)}return o&&c.setKey("members",[...n.members]),o})(s,i)?(H.playUpgrade(),this.showToast(`UPGRADED: ${i.toUpperCase()}`,"success"),this.renderMedicalTab(e,t)):this.showToast("INSUFFICIENT FUNDS","error")})})}renderRecruitTab(e,t){const n=Object.keys(r),s=n[Math.floor(Math.random()*n.length)],{art:i,name:a,description:o}=P.generatePortrait(),l={name:a,class:s,description:o,cost:1e3,art:i};e.innerHTML=`\n      <div class="p-2 flex flex-col gap-4">\n        <h3 class="text-cp-yellow font-cyber">RECRUIT NEW MEMBERS</h3>\n        <div class="font-mono text-[10px] leading-none whitespace-pre text-cp-cyan bg-black/50 p-4 border border-cp-cyan/30 overflow-hidden select-none flex justify-center items-center min-h-[120px]">${l.art}</div>\n\n        <div class="border-l-4 border-cp-yellow pl-4">\n          <h3 class="text-white text-2xl font-cyber font-bold mb-1">${l.name}</h3>\n          <div class="text-cp-yellow text-sm font-cyber mb-2">CLASS: ${l.class}</div>\n          <p class="text-gray-400 text-sm italic mb-3">"${l.description}"</p>\n          <div class="text-cp-cyan text-sm font-bold font-cyber border-t border-gray-700 pt-2">\n            PASSIVE: ${r[l.class].passive}\n          </div>\n        </div>\n\n        <button id="recruit-btn" class="cyber-btn w-full py-4 text-xl mt-2 group relative overflow-hidden">\n          <span class="relative z-10">JOIN ${c.get().gangName.toUpperCase()} (${l.cost}€)</span>\n          <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>\n        </button>\n      </div>\n    `,e.querySelector("#recruit-btn")?.addEventListener("click",()=>{H.playClick();c.get().eddies>=l.cost?(d(-1e3),((e,t,n="",s)=>{const i=c.get(),a=Object.keys(r),o=a[Math.floor(Math.random()*a.length)],l=Math.min(i.rep/25,4),d=3+Math.floor(l),p=7+Math.floor(1.5*l),u=1+Math.floor(.75*l),h={id:Date.now(),name:e,class:s||o,description:t||"A fresh recruit ready for action.",art:n,status:"IDLE",level:u,xp:0,xpToNext:100*Math.pow(1.5,u-1),health:100+10*(u-1),maxHealth:100+10*(u-1),injured:!1,stats:{cool:Math.floor(Math.random()*(p-d+1))+d,reflex:Math.floor(Math.random()*(p-d+1))+d},currentMission:null},m=[...c.get().members,h];c.setKey("members",m)})(l.name,l.description,l.art,l.class),H.playPurchase(),this.showToast("MEMBER RECRUITED","success"),this.renderRecruitTab(e,t)):this.showToast("INSUFFICIENT FUNDS","error")})}renderRosterTab(e){e.innerHTML="";const t=c.get(),n=document.createElement("h3");n.className="text-cp-yellow font-cyber text-2xl mb-4 text-center uppercase tracking-wider",n.textContent=`${t.gangName}'S CREW`,e.appendChild(n);const s=document.createElement("div");s.className="w-full h-[120px] bg-black/30 border-2 border-cp-yellow relative overflow-hidden mb-4",s.innerHTML='\n      <div class="absolute left-[-150px] bottom-[10px] w-[150px] h-[100px]" style="animation: bikerSlide 4s linear infinite;">\n        <img src="assets/biker.png" class="w-full h-full object-contain drop-shadow-[0_0_5px_var(--color-cp-cyan)]" />\n      </div>\n    ',e.appendChild(s),0!==t.members.length?t.members.forEach(t=>{const n=document.createElement("div");n.className="bg-black/60 border-2 border-cp-cyan p-4 mb-3";const s=t.health/t.maxHealth*100,i=t.xp/t.xpToNext*100;let a="text-green-500",o="IDLE";t.injured?(a="text-cp-red",o="INJURED"):"ON MISSION"===t.status&&(a="text-cp-yellow",o="ON MISSION"),n.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n          <div>\n            <div class="text-cp-cyan font-bold text-lg font-cyber">${t.name} <span class="text-sm text-cp-yellow">LVL ${t.level}</span></div>\n            <div class="text-cp-cyan text-xs font-cyber mt-1">CLASS: ${t.class}</div>\n          </div>\n          <div class="text-sm font-bold ${a}">${o}</div>\n        </div>\n\n        <div class="relative h-6 bg-gray-800 mb-2">\n          <div class="absolute inset-0 bg-green-500" style="width: ${s}%"></div>\n          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${t.health}/${t.maxHealth} HP</div>\n        </div>\n\n        <div class="relative h-4 bg-gray-800 mb-2">\n          <div class="absolute inset-0 bg-cp-yellow" style="width: ${i}%"></div>\n          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${t.xp}/${t.xpToNext} XP</div>\n        </div>\n\n        <div class="flex gap-4 text-sm text-gray-400 font-cyber">\n          <span>COOL: ${t.stats.cool}</span>\n          <span>REF: ${t.stats.reflex}</span>\n        </div>\n      `,e.appendChild(n)}):e.innerHTML+='<div class="text-cp-red text-center p-10 font-cyber text-xl">NO GANG MEMBERS. RECRUIT SOME AT THE BAR!</div>'}renderTerritoryTab(e){this.mapInterface.cleanupTooltips(),e.style.position="relative",this.mapInterface.mount(e);const t=document.createElement("button");t.className="bg-black/90 border-2 border-cp-cyan text-cp-cyan w-12 h-12 rounded-full font-bold text-xl hover:bg-cp-cyan hover:text-black transition-colors shadow-[0_0_15px_rgba(0,240,255,0.5)]",t.style.position="absolute",t.style.top="30px",t.style.right="15px",t.style.zIndex="100",t.innerText="?",t.onclick=()=>this.openTerritoryTutorial(),e.appendChild(t);const n=document.createElement("div");n.id="event-ticker",n.className="absolute top-4 left-1/2 -translate-x-1/2 z-10 bg-black/80 border-y border-cp-yellow text-cp-yellow px-6 py-2 font-cyber text-sm uppercase tracking-widest shadow-[0_0_15px_rgba(255,215,0,0.3)] hidden",n.innerHTML='<span class="animate-pulse">⚠ ACTIVE EVENT: <span id="event-name">POLICE RAID</span></span>',e.appendChild(n);const s=R.getCurrentEvent();s&&(n.querySelector("#event-name").textContent=s.name,n.classList.remove("hidden"))}openTerritoryModal(e){const t=c.get().territories.find(t=>t.id===e);if(!t)return;if("BADLANDS"===t.name)return void this.openHideoutModal();const n=this.createOverlay(),s=document.createElement("div");s.className="bg-cp-bg border-[3px] shadow-[0_0_40px_rgba(0,0,0,0.5)] w-[90%] max-w-[600px] flex flex-col animate-modalSlideIn pointer-events-auto transition-colors duration-300",this.renderModalContent(s,e),n.appendChild(s),this.modalContainer.appendChild(n);const i=c.subscribe(()=>{document.body.contains(s)&&this.renderModalContent(s,e)});s.addEventListener("click",t=>{const s=t.target;if(("close-territory"===s.id||s.closest("#close-territory"))&&(this.mapInterface.cleanupTooltips(),i(),n.remove()),s.classList.contains("op-btn")){const t=s.dataset.op;this.handleOperationClick(t,e,n)}if(s.classList.contains("upgrade-territory-btn")||s.closest(".upgrade-territory-btn")){const t=s.classList.contains("upgrade-territory-btn")?s:s.closest(".upgrade-territory-btn"),n=t?.dataset.upgrade;if(n){const t=((e,t)=>{const n=c.get(),s=n.territories.find(t=>t.id===e);if(!s)return{success:!1,message:"Territory not found"};if(!s.controlled)return{success:!1,message:"Must control territory first"};if(s.upgrades.length>=s.slots)return{success:!1,message:"No slots available"};if(s.upgrades.includes(t))return{success:!1,message:"Upgrade already installed"};const i=l[t];if(n.eddies<i.cost)return{success:!1,message:"Insufficient funds"};switch(d(-i.cost),s.upgrades.push(t),t){case"MARKET":break;case"FORTIFICATION":s.defense=Math.min(100,s.defense+20),s.stability=Math.min(100,s.stability+10)}return c.setKey("territories",[...n.territories]),{success:!0,message:`${i.name} built successfully!`}})(e,n);t.success?(H.playPurchase(),this.showToast(t.message,"success")):this.showToast(t.message,"error")}}})}renderModalContent(e,t){const n=c.get().territories.find(e=>e.id===t);if(!n)return;const s=n.controlled,i=n.rivalGang?o.getGangByTerritory(n.id):null,a=s?"#00F0FF":i?.color||"#888";e.style.borderColor=a,e.style.boxShadow=`0 0 40px ${a}40`,e.innerHTML=`\n        <div class="bg-black/80 border-b-2 p-5 flex justify-between items-center shrink-0" style="border-color: ${a}">\n            <div>\n                <h2 class="text-white m-0 text-3xl font-cyber font-bold uppercase" style="text-shadow: 0 0 10px ${a}">${n.name}</h2>\n                <div class="text-sm font-cyber text-gray-400">${n.district}</div>\n            </div>\n            <div class="flex gap-2">\n\n                <button id="close-territory" class="bg-transparent border-2 text-white text-3xl w-10 h-10 cursor-pointer flex items-center justify-center font-bold hover:bg-white/10" style="border-color: ${a}">&times;</button>\n            </div>\n        </div>\n\n        <div class="p-6 overflow-y-auto max-h-[70vh]">\n            <p class="text-white text-lg mb-6 font-cyber leading-relaxed border-l-4 pl-4 bg-black/30 p-4" style="border-color: ${a}">\n                "${n.description}"\n            </p>\n            \n            <div class="grid grid-cols-2 gap-4 mb-6">\n                <div class="bg-black/40 border border-gray-700 p-3">\n                    <div class="text-xs text-gray-400 font-cyber">CONTROL</div>\n                    <div class="text-xl font-bold font-cyber" style="color: ${a}">\n                        ${s?"YOUR GANG":i?i.name:"UNCLAIMED"}\n                    </div>\n                </div>\n                <div class="bg-black/40 border border-gray-700 p-3">\n                    <div class="text-xs text-gray-400 font-cyber">INCOME</div>\n                    <div class="text-xl text-cp-yellow font-bold font-cyber">+${n.income}€ / 1m</div>\n                </div>\n                <div class="bg-black/40 border border-gray-700 p-3">\n                    <div class="text-xs text-gray-400 font-cyber">DEFENSE</div>\n                    <div class="w-full h-2 bg-gray-800 mt-1">\n                        <div class="h-full bg-blue-500 transition-all duration-500" style="width: ${n.defense}%"></div>\n                    </div>\n                    <div class="text-right text-xs text-blue-400 mt-1">${n.defense}%</div>\n                </div>\n                <div class="bg-black/40 border border-gray-700 p-3">\n                    <div class="text-xs text-gray-400 font-cyber">HEAT</div>\n                    <div class="w-full h-2 bg-gray-800 mt-1">\n                        <div class="h-full bg-red-500 transition-all duration-500" style="width: ${n.heat}%"></div>\n                    </div>\n                    <div class="text-right text-xs text-red-400 mt-1">${n.heat}%</div>\n                </div>\n            </div>\n\n            \x3c!-- Operations Section --\x3e\n            <div class="border-t border-gray-700 pt-4">\n                <div class="flex justify-between items-center mb-3">\n                    <h3 class="text-cp-cyan font-cyber text-lg">OPERATIONS</h3>\n                    ${s?"":`<div class="text-xs text-gray-400">INTEL: <span class="text-white">${n.intel||0}%</span></div>`}\n                </div>\n                <div class="grid grid-cols-2 gap-3">\n                    <button class="op-btn cyber-btn text-sm py-2" data-op="SCOUT">SCOUT (50€)</button>\n                    ${s?`\n                        <button class="op-btn cyber-btn text-sm py-2" data-op="FORTIFY">FORTIFY (200€)</button>\n                        ${R.getActiveOperations(n.id).some(e=>"ASSAULT"===e.type&&"PLAYER"!==e.initiatorGangId)?'<button class="op-btn cyber-btn text-sm py-2 bg-red-600 hover:bg-red-500 animate-pulse" data-op="DEFEND">DEFEND! (FREE)</button>':""}\n                    `:'\n                        <button class="op-btn cyber-btn text-sm py-2" data-op="SABOTAGE">SABOTAGE (300€)</button>\n                        <button class="op-btn cyber-btn text-sm py-2" data-op="RAID">RAID (100€)</button>\n                        <button class="op-btn cyber-btn text-sm py-2 bg-red-900/50 hover:bg-red-900" data-op="ASSAULT">ASSAULT (1000€)</button>\n                    '}\n                </div>\n            </div>\n            \n            ${s?`\n            \x3c!-- District Upgrades Section --\x3e\n            <div class="border-t border-gray-700 pt-4 mt-4">\n                <div class="flex justify-between items-center mb-3">\n                    <h3 class="text-cp-yellow font-cyber text-lg">DISTRICT UPGRADES</h3>\n                    <div class="text-xs text-gray-400">SLOTS: <span class="text-white">${n.upgrades.length}/${n.slots}</span></div>\n                </div>\n                \n                \x3c!-- Installed Upgrades --\x3e\n                ${n.upgrades.length>0?`\n                    <div class="mb-3">\n                        <div class="text-xs text-gray-500 mb-2">INSTALLED</div>\n                        <div class="flex flex-wrap gap-2">\n                            ${n.upgrades.map(e=>`\n                                <div class="bg-cp-yellow/20 border border-cp-yellow px-3 py-1 text-xs font-cyber text-cp-yellow">\n                                    ${l[e].name.toUpperCase()}\n                                </div>\n                            `).join("")}\n                        </div>\n                    </div>\n                `:""}\n                \n                \x3c!-- Available Upgrades --\x3e\n                ${n.upgrades.length<n.slots?`\n                    <div class="grid grid-cols-1 gap-2">\n                        ${Object.values(l).filter(e=>!n.upgrades.includes(e.type)).map(e=>`\n                            <button class="upgrade-territory-btn bg-black/40 border border-gray-600 hover:border-cp-yellow p-3 text-left transition-colors group" data-upgrade="${e.type}">\n                                <div class="flex justify-between items-start mb-1">\n                                    <span class="font-cyber text-white group-hover:text-cp-yellow">${e.name}</span>\n                                    <span class="text-cp-yellow font-bold">${e.cost}€</span>\n                                </div>\n                                <div class="text-xs text-gray-400 mb-1">${e.description}</div>\n                                <div class="text-xs text-cp-cyan">${e.effect}</div>\n                            </button>\n                        `).join("")}\n                    </div>\n                `:'\n                    <div class="text-center text-gray-500 text-sm py-2">ALL SLOTS FILLED</div>\n                '}\n            </div>\n            `:""}\n            \n            <div id="active-ops" class="mt-4"></div>\n        </div>\n    `;const r=e.querySelector("#active-ops"),d=R.getActiveOperations(n.id);d.length>0&&(r.innerHTML='<div class="text-xs text-gray-500 mb-2">ACTIVE OPERATIONS</div>',d.forEach(e=>{const t=document.createElement("div");t.className="bg-black/50 border border-gray-600 p-2 text-sm flex justify-between mb-1",t.innerHTML=`\n                <span class="text-cp-cyan">${e.type}</span>\n                <span class="text-gray-400">${Math.ceil((e.endTime-Date.now())/1e3)}s</span>\n              `,r.appendChild(t)}))}handleOperationClick(e,t,n){const s=c.get();let i=0,a=1e4,o=100;const r=10*s.rep,l=s.upgrades.find(e=>"ARMORY"===e.id),p=500+r+(l?100*l.level:0);switch(e){case"SCOUT":i=50,a=5e3;break;case"SABOTAGE":i=300,a=1e4;break;case"RAID":i=100,o=200,a=15e3;break;case"ASSAULT":i=1e3,o=p,a=3e4;break;case"FORTIFY":i=200,a=1e4;break;case"DEFEND":i=0,o=p,a=2e4}s.eddies>=i?(d(-i),R.startOperation(e,t,"PLAYER",o,a),H.playPurchase(),this.showToast(`${e} OPERATION STARTED`,"success"),n.remove()):this.showToast("INSUFFICIENT FUNDS","error")}openHideoutModal(){const e=c.get(),t=this.createOverlay(),n=document.createElement("div");n.className="bg-cp-bg border-[3px] border-cp-yellow shadow-[0_0_40px_rgba(255,215,0,0.5)] w-[90%] max-w-[800px] h-[80vh] flex flex-col animate-modalSlideIn pointer-events-auto",n.innerHTML=`\n        <div class="bg-black/80 border-b-2 border-cp-yellow p-5 flex justify-between items-center shrink-0">\n            <h2 class="text-cp-yellow m-0 text-3xl font-cyber font-bold uppercase">HIDEOUT UPGRADES</h2>\n            <button id="close-hideout" class="bg-transparent border-2 border-cp-yellow text-cp-yellow text-3xl w-10 h-10 cursor-pointer flex items-center justify-center font-bold hover:bg-cp-yellow hover:text-black">&times;</button>\n        </div>\n\n        <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">\n            ${e.upgrades.map(t=>{const n=t.level>=t.maxLevel,s=Math.floor(t.cost*Math.pow(1.5,t.level)),i=e.eddies>=s;return`\n                <div class="bg-black/40 border-2 ${n?"border-cp-cyan":"border-gray-600"} p-4 flex flex-col relative overflow-hidden group hover:border-cp-yellow transition-colors">\n                    <div class="flex justify-between items-start mb-2">\n                        <h3 class="text-xl font-cyber font-bold text-white">${t.name}</h3>\n                        <div class="text-cp-yellow font-bold">LVL ${t.level}/${t.maxLevel}</div>\n                    </div>\n                    <p class="text-gray-400 text-sm mb-4 h-10">${t.description}</p>\n                    <div class="text-xs text-cp-cyan mb-4">${t.effect}</div>\n                    \n                    <div class="mt-auto">\n                        ${n?'<button class="w-full py-2 bg-cp-cyan/20 text-cp-cyan font-bold border border-cp-cyan cursor-default">MAX LEVEL</button>':`<button class="upgrade-btn w-full py-2 ${i?"bg-cp-yellow text-black hover:bg-white":"bg-gray-800 text-gray-500 cursor-not-allowed"} font-bold font-cyber transition-colors" \n                                data-id="${t.id}" ${i?"":"disabled"}>\n                                UPGRADE (${s}€)\n                            </button>`}\n                    </div>\n                </div>\n            `}).join("")}\n        </div>\n    `,t.appendChild(n),this.modalContainer.appendChild(t),n.querySelector("#close-hideout")?.addEventListener("click",()=>t.remove()),n.querySelectorAll(".upgrade-btn").forEach(e=>{e.addEventListener("click",e=>{const n=e.currentTarget.dataset.id;this.handleUpgrade(n,t)})})}handleUpgrade(e,t){const n=c.get(),s=n.upgrades.find(t=>t.id===e);if(!s)return;if(s.level>=s.maxLevel)return;const i=Math.floor(s.cost*Math.pow(1.5,s.level));n.eddies>=i?(d(-i),s.level++,c.setKey("upgrades",[...n.upgrades]),H.playPurchase(),this.showToast(`${s.name} UPGRADED TO LEVEL ${s.level}`,"success"),t.remove(),this.openHideoutModal()):this.showToast("INSUFFICIENT FUNDS","error")}openDiplomacyTutorial(){const e=this.createOverlay(),t=document.createElement("div");t.className="bg-black/95 border border-cp-yellow p-8 max-w-[500px] text-white font-cyber relative animate-modalSlideIn shadow-[0_0_50px_rgba(255,215,0,0.2)] pointer-events-auto",t.innerHTML='\n        <h2 class="text-2xl text-cp-yellow font-bold mb-4 border-b border-gray-700 pb-2">DIPLOMACY GUIDE</h2>\n        <div class="space-y-4 text-sm text-gray-300">\n            <div>\n                <strong class="text-white">RELATIONSHIP:</strong> Ranges from -100 (WAR) to +100 (ALLY).\n                <ul class="list-disc pl-5 mt-1 space-y-1 text-xs">\n                    <li><span class="text-red-500">WAR (-50):</span> They will attack your turf.</li>\n                    <li><span class="text-green-400">FRIENDLY (+0):</span> Open to trade.</li>\n                    <li><span class="text-cp-cyan">ALLY (+80):</span> Will defend you.</li>\n                </ul>\n            </div>\n            <div>\n                <strong class="text-white">PACTS:</strong>\n                <ul class="list-disc pl-5 mt-1 space-y-1 text-xs">\n                    <li><span class="text-cp-yellow">NON-AGGRESSION:</span> Prevents attacks for a duration.</li>\n                    <li><span class="text-cp-cyan">ALLIANCE:</span> Mutual defense and shared intel.</li>\n                </ul>\n            </div>\n            <div class="border-t border-gray-700 pt-2 mt-2">\n                <strong class="text-cp-yellow">ACTIONS:</strong>\n                <ul class="list-disc pl-5 mt-1 space-y-1">\n                    <li><span class="text-white">BRIBE:</span> Pay eddies to improve relations.</li>\n                    <li><span class="text-white">TRUCE:</span> End a war immediately.</li>\n                    <li><span class="text-white">ALLIANCE:</span> Form a pact for mutual benefit.</li>\n                </ul>\n            </div>\n        </div>\n        <button class="mt-6 w-full bg-cp-yellow text-black font-bold py-2 hover:bg-white transition-colors">GOT IT</button>\n    ',t.querySelector("button")?.addEventListener("click",()=>e.remove()),e.appendChild(t),this.modalContainer.appendChild(e)}renderGangsTab(e){const t=o.getGangInfo();e.innerHTML="";const n=document.createElement("div");n.className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2",n.innerHTML='\n        <h3 class="text-cp-yellow font-cyber text-2xl uppercase tracking-wider">RIVAL GANGS</h3>\n        <button id="diplomacy-help-btn" class="bg-black/90 border-2 border-cp-cyan text-cp-cyan w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl hover:bg-cp-cyan hover:text-black transition-colors shadow-[0_0_15px_rgba(0,240,255,0.5)]">?</button>\n    ',e.appendChild(n),n.querySelector("#diplomacy-help-btn")?.addEventListener("click",()=>this.openDiplomacyTutorial());const s=document.createElement("div");s.className="grid grid-cols-1 md:grid-cols-2 gap-4",t.forEach(e=>{const t=document.createElement("div");t.className="bg-black/40 border-2 p-4 cursor-pointer hover:bg-white/5 transition-colors",t.style.borderColor=e.color;let n="NEUTRAL",i="text-gray-400";e.relationship<=-50?(n="WAR",i="text-red-500"):e.relationship<0?(n="HOSTILE",i="text-orange-500"):e.relationship>=80?(n="ALLY",i="text-cp-cyan"):e.relationship>0&&(n="FRIENDLY",i="text-green-400"),t.innerHTML=`\n            <div class="flex justify-between items-center mb-2">\n                <h3 class="text-xl font-cyber font-bold text-white" style="text-shadow: 0 0 5px ${e.color}">${e.name}</h3>\n                <div class="text-sm font-bold ${i}">${n} (${e.relationship})</div>\n            </div>\n            <div class="grid grid-cols-2 gap-2 text-sm text-gray-300 mb-3">\n                <div>STR: ${e.strength}</div>\n                <div>TURF: ${e.territories}</div>\n                <div>AGGR: ${e.personality.toUpperCase()}</div>\n            </div>\n            <div class="w-full bg-gray-800 h-1 mt-2">\n                <div class="h-full transition-all" style="width: ${Math.max(0,e.relationship+100)/2}%; background-color: ${e.color}"></div>\n            </div>\n        `,t.addEventListener("click",()=>{this.openDiplomacyModal(e.id)}),s.appendChild(t)}),e.appendChild(s)}openDiplomacyModal(e){const t=o.getGangById(e);if(!t)return;const n=this.createOverlay(),s=document.createElement("div"),i=t.color||"#fff";let a="NEUTRAL",r="#999",l="Neutral stance. May attack or leave you alone.";t.relationship<=-50?(a="WAR",r="#FF0000",l="Hostile! Will attack your territories frequently."):t.relationship>=80?(a="ALLY",r="#00FF00",l="Allied! Will help defend your territories when under attack."):t.relationship>=30&&(a="FRIENDLY",r="#00FFFF",l="Friendly. Less likely to attack, open to diplomacy."),s.className="bg-cp-bg border-[3px] shadow-[0_0_40px_rgba(0,0,0,0.5)] w-[90%] max-w-[600px] flex flex-col animate-modalSlideIn pointer-events-auto",s.style.borderColor=i,s.style.boxShadow=`0 0 30px ${i}40`,s.innerHTML=`\n        <div class="bg-black/ 80 border-b-2 p-5 flex justify-between items-center shrink-0" style="border-color: ${i}">\n            <h2 class="text-white m-0 text-3xl font-cyber font-bold uppercase" style="text-shadow: 0 0 10px ${i}">${t.name}</h2>\n            <button id="close-diplomacy" class="bg-transparent border-2 text-white text-3xl w-10 h-10 cursor-pointer flex items-center justify-center font-bold hover:bg-white/10" style="border-color: ${i}">&times;</button>\n        </div>\n\n        <div class="p-6">\n            <div class="flex items-center gap-4 mb-4 bg-black/30 p-4 border-l-4" style="border-color: ${i}">\n                <div class="text-4xl">🤝</div>\n                <div>\n                    <div class="text-gray-400 text-sm font-cyber">RELATIONSHIP</div>\n                    <div class="text-2xl font-bold text-white">${t.relationship} / 100</div>\n                </div>\n            </div>\n\n            <div class="bg-black/40 p-4 border-l-4 mb-6" style="border-color: ${r}">\n                <div class="flex items-center gap-2 mb-2">\n                    <span class="text-xl font-cyber" style="color: ${r}">STATUS: ${a}</span>\n                </div>\n                <p class="text-gray-300 text-sm leading-relaxed">${l}</p>\n            </div>\n\n            <h3 class="text-cp-cyan font-cyber text-lg mb-3">DIPLOMATIC ACTIONS</h3>\n            <div class="space-y-3">\n                <button class="dip-btn cyber-btn w-full py-3 flex justify-between items-center px-4" data-action="BRIBE">\n                    <span>BRIBE (Improve Relations)</span>\n                    <span class="text-cp-yellow font-bold">500€</span>\n                </button>\n                <button class="dip-btn cyber-btn w-full py-3 flex justify-between items-center px-4" data-action="TRUCE">\n                    <span>OFFER TRUCE (End War)</span>\n                    <span class="text-cp-yellow font-bold">1000€</span>\n                </button>\n                <button class="dip-btn cyber-btn w-full py-3 flex justify-between items-center px-4 border-cp-cyan text-cp-cyan hover:bg-cp-cyan/10" data-action="ALLIANCE">\n                    <span>PROPOSE ALLIANCE</span>\n                    <span class="text-cp-yellow font-bold">2000€</span>\n                </button>\n            </div>\n        </div>\n    `,n.appendChild(s),this.modalContainer.appendChild(n),s.querySelector("#close-diplomacy")?.addEventListener("click",()=>n.remove()),s.querySelectorAll(".dip-btn").forEach(e=>{e.addEventListener("click",e=>{const s=e.currentTarget.dataset.action;this.handleDiplomacyAction(s,t.id,n)})})}handleDiplomacyAction(e,t,n){const s=c.get(),i=o.getGangById(t);if(i)switch(e){case"BRIBE":s.eddies>=500?(d(-500),o.changeRelationship(t,10),H.playPurchase(),this.showToast(`BRIBED ${i.name}`,"success"),n.remove()):this.showToast("INSUFFICIENT FUNDS","error");break;case"TRUCE":if(s.eddies>=1e3){if(i.relationship>=0)return void this.showToast("ALREADY AT PEACE","warning");d(-1e3),i.relationship=0,H.playLevelUp(),this.showToast(`TRUCE SIGNED WITH ${i.name}`,"success"),n.remove()}else this.showToast("INSUFFICIENT FUNDS","error");break;case"ALLIANCE":if(s.eddies>=2e3&&s.rep>=80){if(i.relationship<80)return void this.showToast("RELATIONSHIP TOO LOW","warning");d(-2e3),o.setAlliance(t,!0),H.playLevelUp(),this.showToast(`ALLIANCE FORMED WITH ${i.name}!`,"success"),n.remove()}else this.showToast("REQ: 2000€, 80 REP, 80+ REL","error")}}openTerritoryTutorial(){const e=this.createOverlay(),t=document.createElement("div");t.className="bg-cyber border-2 border-cp-cyan max-w-3xl mx-auto my-12 shadow-[0_0_30px_rgba(0,240,255,0.4)]",t.innerHTML='\n        <div class="flex justify-between items-center p-4 bg-cp-cyan/10 border-b-2 border-cp-cyan">\n            <h2 class="text-2xl font-cyber text-cp-cyan uppercase tracking-wider">Territory Warfare Guide</h2>\n            <button id="close-tutorial" class="bg-transparent border-2 border-cp-cyan text-cp-cyan text-3xl w-10 h-10 cursor-pointer flex items-center justify-center font-bold hover:bg-cp-cyan hover:text-black transition-colors">&times;</button>\n        </div>\n\n        <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">\n            \x3c!-- Operations --\x3e\n            <div class="bg-black/30 p-4 border-l-4 border-cp-yellow">\n                <h3 class="text-cp-yellow font-cyber text-xl mb-2 uppercase">Operations</h3>\n                <div class="space-y-2 text-gray-300">\n                    <div><span class="text-cp-cyan font-bold">SCOUT</span> - Gather intel on territories. Higher intel reveals Defense, Income, Garrison strength, and weaknesses.</div>\n                    <div><span class="text-cp-cyan font-bold">SABOTAGE</span> - Weaken defenses covertly with minimal heat gain.</div>\n                    <div><span class="text-cp-cyan font-bold">RAID</span> - Quick attack to steal eddies and weaken territory (increases heat).</div>\n                    <div><span class="text-cp-cyan font-bold">ASSAULT</span> - Full attack to capture territory. Requires high power and generates massive heat.</div>\n                    <div><span class="text-cp-cyan font-bold">FORTIFY</span> - Strengthen your territory\'s defenses.</div>\n                </div>\n            </div>\n\n            \x3c!-- Intel System --\x3e\n            <div class="bg-black/30 p-4 border-l-4 border-blue-400">\n                <h3 class="text-blue-400 font-cyber text-xl mb-2 uppercase">Intel System</h3>\n                <div class="space-y-2 text-gray-300">\n                    <div>Intel unlocks progressive information about territories:</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">25%</span> - Defense & Stability</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">50%</span> - Income & Building Slots</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">75%</span> - Enemy Garrison Strength</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">100%</span> - Critical Weakness (+10% combat bonus)</div>\n                </div>\n            </div>\n\n            \x3c!-- Events --\x3e\n            <div class="bg-black/30 p-4 border-l-4 border-cp-yellow">\n                <h3 class="text-cp-yellow font-cyber text-xl mb-2 uppercase">Global Events</h3>\n                <div class="space-y-2 text-gray-300">\n                    <div>Watch for random events that affect gameplay:</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">POLICE CRACKDOWN</span> - Heat rises faster</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">BLACK MARKET BOOM</span> - Increased income</div>\n                    <div class="ml-4">• <span class="text-cp-cyan">GANG WARFARE</span> - Rivals distracted</div>\n                </div>\n            </div>\n\n            \x3c!-- Heat & Police --\x3e\n            <div class="bg-black/30 p-4 border-l-4 border-red-500">\n                <h3 class="text-red-500 font-cyber text-xl mb-2 uppercase">Heat & Police</h3>\n                <div class="space-y-2 text-gray-300">\n                    <div><span class="text-cp-cyan font-bold">HEAT</span> - Increases with aggressive operations. High heat (80+) triggers police raids.</div>\n                    <div><span class="text-cp-cyan font-bold">POLICE RAIDS</span> - Damage defense/stability and cost 500€ in bribes. Heat drops after raid.</div>\n                    <div>Manage heat carefully to avoid costly interference.</div>\n                </div>\n            </div>\n\n            \x3c!-- Tips --\x3e\n            <div class="bg-black/30 p-4 border-l-4 border-green-400">\n                <h3 class="text-green-400 font-cyber text-xl mb-2 uppercase">Strategic Tips</h3>\n                <div class="space-y-2 text-gray-300">\n                    <div>• Scout before assaulting to gain combat bonuses</div>\n                    <div>• Use sabotage to weaken targets without raising heat</div>\n                    <div>• Build relationships before demanding tribute or requesting proxy wars</div>\n                    <div>• Monitor global events for strategic opportunities</div>\n                    <div>• Fortify territories regularly to prevent enemy captures</div>\n                </div>\n            </div>\n        </div>\n    ',e.appendChild(t),this.modalContainer.appendChild(e),t.querySelector("#close-tutorial")?.addEventListener("click",()=>e.remove()),e.addEventListener("click",t=>{t.target===e&&e.remove()})}}document.addEventListener("DOMContentLoaded",()=>{const e=M.loadGame();e&&(e=>{Object.keys(e).forEach(t=>{c.setKey(t,e[t])})})(e);const t=M.loadSettings();if(t)H.setMusicVolume(t.musicVolume),H.setSfxVolume(t.sfxVolume),H.setMusicEnabled(t.musicEnabled),H.setSfxEnabled(t.sfxEnabled);else{const e=M.getDefaultSettings();M.saveSettings(e),H.setMusicVolume(e.musicVolume),H.setSfxVolume(e.sfxVolume)}A.getInstance().initialize(),new U});
